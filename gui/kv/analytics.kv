#:kivy 2.0
#:import MDTabsPrimary kivymd.uix.tab.MDTabsPrimary
#:import MDTabsItem kivymd.uix.tab.MDTabsItem
#:import MDTabsItemText kivymd.uix.tab.MDTabsItemText
#:import MDTabsCarousel kivymd.uix.tab.MDTabsCarousel
#:import MDCard kivymd.uix.card.MDCard
#:import MDScrollView kivymd.uix.scrollview.MDScrollView
#:import MDLabel kivymd.uix.label.MDLabel
#:import MDButton kivymd.uix.button.MDButton
#:import MDIconButton kivymd.uix.button.MDIconButton
#:import MDBoxLayout kivymd.uix.boxlayout.MDBoxLayout
#:import MDDialog kivymd.uix.dialog.MDDialog
#:import GridLayout kivy.uix.gridlayout.GridLayout
#:import MDCircularProgressIndicator kivymd.uix.progressindicator.MDCircularProgressIndicator
#:import MDCheckbox kivymd.uix.selectioncontrol.MDCheckbox
#:import MDDropdownMenu kivymd.uix.menu.MDDropdownMenu
#:import MDListItem kivymd.uix.list.MDListItem
#:import MDListItemHeadlineText kivymd.uix.list.MDListItemHeadlineText
#:import MDListItemSupportingText kivymd.uix.list.MDListItemSupportingText

# Main Analytics Screen Layout
<AnalyticsScreen>:
    name: 'analytics'
    
    MDBoxLayout:
        id: main_content
        orientation: 'vertical'
        spacing: dp(16)
        padding: [dp(24), dp(8), dp(24), dp(20)]
        
        # Top Navigation Bar
        TopBar:
            id: top_bar
            size_hint_y: None
            height: dp(56)
        
        # Analytics Controls Card
        AnalyticsControlsCard:
            id: analytics_controls
        
        # Project Overview Card
        ProjectOverviewCard:
            id: project_overview_card
        
        # Analytics Navigation Cards
        AnalyticsNavigationGrid:
            id: analytics_navigation

# Analytics Controls Card Component
<AnalyticsControlsCard@MDCard>:
    orientation: 'horizontal'
    size_hint_y: None
    height: dp(64)
    elevation: 2
    md_bg_color: 0.98, 0.99, 1.0, 1
    radius: [12, 12, 12, 12]
    padding: [dp(20), dp(12), dp(20), dp(12)]
    spacing: dp(16)
    
    # Title Section
    AnalyticsTitleSection:
        id: analytics_title_section
    
    # Project Selector
    ProjectSelectorButton:
        id: project_selector
    
    # Action Buttons
    AnalyticsActionButtons:
        id: analytics_action_buttons

# Analytics Title Section Component
<AnalyticsTitleSection@MDBoxLayout>:
    orientation: 'horizontal'
    spacing: dp(12)
    size_hint_x: 0.3
    
    MDIconButton:
        icon: "chart-line"
        theme_icon_color: "Custom"
        icon_color: app.theme_cls.primaryColor
        size_hint_x: None
        width: dp(36)
        icon_size: "20dp"
        disabled: True
    
    MDLabel:
        text: "Analytics"
        theme_text_color: "Primary"
        font_style: "Headline"
        role: "small"
        bold: True
        text_size: self.width, None
        halign: "left"
        valign: "center"

# Project Selector Button Component
<ProjectSelectorButton@MDButton>:
    style: "filled"
    size_hint_x: 0.5
    height: dp(44)
    md_bg_color: app.theme_cls.primaryColor
    on_release: app.root.get_screen('analytics').open_project_menu()
    
    MDButtonText:
        text: "Select Project for Analysis"
        font_size: "15sp"
        theme_text_color: "Custom"
        text_color: 1, 1, 1, 1

# Analytics Action Buttons Component
<AnalyticsActionButtons@MDBoxLayout>:
    orientation: 'horizontal'
    spacing: dp(8)
    size_hint_x: 0.2
    
    MDIconButton:
        icon: "refresh"
        theme_icon_color: "Custom"
        icon_color: app.theme_cls.primaryColor
        size_hint_x: None
        width: dp(44)
        icon_size: "18dp"
        on_release: app.root.get_screen('analytics').update_quick_stats() if app.root else None
        disabled: not (app.root and hasattr(app.root, 'get_screen') and app.root.get_screen('analytics').current_project_id)
    
    MDIconButton:
        icon: "download"
        theme_icon_color: "Custom"
        icon_color: app.theme_cls.primaryColor
        size_hint_x: None
        width: dp(44)
        icon_size: "18dp"
        disabled: not (app.root and hasattr(app.root, 'get_screen') and app.root.get_screen('analytics').current_project_id)

# Project Overview Card Component
<ProjectOverviewCard@MDCard>:
    orientation: 'vertical'
    size_hint_y: None
    height: dp(264)
    elevation: 2
    md_bg_color: 0.98, 0.99, 1.0, 1
    radius: [12, 12, 12, 12]
    padding: [dp(20), dp(16), dp(20), dp(16)]
    spacing: dp(16)
    
    # Header with Toggle
    ProjectOverviewHeader:
        id: project_overview_header
    
    # Content Container
    ProjectOverviewContent:
        id: project_overview_content

# Project Overview Header Component
<ProjectOverviewHeader@MDBoxLayout>:
    orientation: 'horizontal'
    spacing: dp(12)
    size_hint_y: None
    height: dp(56)
    
    MDLabel:
        text: "Project Overview"
        font_style: "Headline"

        role: "small"
        theme_text_color: "Primary"
        bold: True
        size_hint_x: 1
        pos_hint: {"center_y": 0.5}
    
    MDIconButton:
        id: stats_toggle_button
        icon: "chevron-down"
        theme_icon_color: "Custom"
        icon_color: app.theme_cls.primaryColor
        size_hint_x: None
        width: dp(48)
        icon_size: "24dp"
        on_release: app.root.get_screen('analytics').toggle_project_overview()
        pos_hint: {"center_y": 0.5}

# Project Overview Content Component
<ProjectOverviewContent@MDBoxLayout>:
    orientation: 'vertical'
    spacing: dp(16)
    size_hint_y: None
    height: dp(176)
    opacity: 1
    
    GridLayout:
        id: stats_container
        cols: 4
        spacing: dp(20)
        size_hint_y: None
        height: dp(176)

# Analytics Navigation Grid Component
<AnalyticsNavigationGrid@MDScrollView>:
    do_scroll_x: False
    do_scroll_y: True
    bar_width: dp(8)
    
    MDBoxLayout:
        orientation: 'vertical'
        spacing: dp(20)
        size_hint_y: None
        height: self.minimum_height
        padding: [dp(16), dp(20), dp(16), dp(20)]
        
        # Welcome card (shown when no project selected)
        AnalyticsWelcomeCard:
            id: welcome_card
            opacity: 0 if (app.root and hasattr(app.root, 'get_screen') and app.root.get_screen('analytics').current_project_id) else 1
            size_hint_y: None if (app.root and hasattr(app.root, 'get_screen') and app.root.get_screen('analytics').current_project_id) else None
            height: 0 if (app.root and hasattr(app.root, 'get_screen') and app.root.get_screen('analytics').current_project_id) else dp(300)
        
        # Navigation grid (shown when project selected)
        GridLayout:
            cols: 2
            spacing: dp(20)
            size_hint_y: None
            height: dp(480) if (app.root and hasattr(app.root, 'get_screen') and app.root.get_screen('analytics').current_project_id) else 0
            opacity: 1 if (app.root and hasattr(app.root, 'get_screen') and app.root.get_screen('analytics').current_project_id) else 0
            
            # Data Exploration Card
            DataExplorationNavigationCard:
                id: data_exploration_card
            
            # Auto Detection Card
            AutoDetectionNavigationCard:
                id: auto_detection_card
            
            # Descriptive Analytics Card
            DescriptiveAnalyticsNavigationCard:
                id: descriptive_analytics_card
            
            # Inferential Analytics Card
            InferentialAnalyticsNavigationCard:
                id: inferential_analytics_card
            
            # Qualitative Analytics Card
            QualitativeAnalyticsNavigationCard:
                id: qualitative_analytics_card

# Navigation Card Components
<DataExplorationNavigationCard@MDCard>:
    orientation: 'vertical'
    size_hint_y: None
    height: dp(220)
    elevation: 3
    md_bg_color: 0.98, 0.99, 1.0, 1
    radius: [16, 16, 16, 16]
    padding: [dp(20), dp(16), dp(20), dp(16)]
    spacing: dp(12)
    ripple_behavior: True
    on_release: app.root.get_screen('analytics').navigate_to_data_exploration()
    
    MDBoxLayout:
        orientation: 'horizontal'
        spacing: dp(12)
        size_hint_y: None
        height: dp(48)
        
        MDIconButton:
            icon: "database-search"
            theme_icon_color: "Custom"
            icon_color: 0.2, 0.6, 1.0, 1
            disabled: True
            size_hint_x: None
            width: dp(48)
            icon_size: "32dp"
        
        MDLabel:
            text: "Data Exploration"
            theme_text_color: "Primary"
            font_style: "Headline"
            role: "small"
            bold: True
            pos_hint: {"center_y": 0.5}
    
    MDLabel:
        text: "Explore and filter your survey data with advanced search, pagination, and sampling tools"
        theme_text_color: "Secondary"
        font_style: "Body"
        role: "medium"
        text_size: self.width, None
        size_hint_y: None
        height: dp(80)
    
    MDBoxLayout:
        orientation: 'horizontal'
        spacing: dp(8)
        size_hint_y: None
        height: dp(40)
        
        MDButton:
            text: "Open Explorer"
            style: "filled"
            size_hint_x: 1
            theme_bg_color: "Custom"
            md_bg_color: 0.2, 0.6, 1.0, 1
            on_release: app.root.get_screen('analytics').navigate_to_data_exploration()
        
        MDIconButton:
            icon: "arrow-right"
            theme_icon_color: "Custom"
            icon_color: 0.2, 0.6, 1.0, 1
            size_hint_x: None
            width: dp(40)
            disabled: True

<AutoDetectionNavigationCard@MDCard>:
    orientation: 'vertical'
    size_hint_y: None
    height: dp(220)
    elevation: 3
    md_bg_color: 0.98, 1.0, 0.98, 1
    radius: [16, 16, 16, 16]
    padding: [dp(20), dp(16), dp(20), dp(16)]
    spacing: dp(12)
    ripple_behavior: True
    on_release: app.root.get_screen('analytics').navigate_to_auto_detection()
    
    MDBoxLayout:
        orientation: 'horizontal'
        spacing: dp(12)
        size_hint_y: None
        height: dp(48)
        
        MDIconButton:
            icon: "auto-fix"
            theme_icon_color: "Custom"
            icon_color: 0.2, 0.8, 0.6, 1
            disabled: True
            size_hint_x: None
            width: dp(48)
            icon_size: "32dp"
        
        MDLabel:
            text: "Auto Detection"
            theme_text_color: "Primary"
            font_style: "Headline"
            role: "small"
            bold: True
            pos_hint: {"center_y": 0.5}
    
    MDLabel:
        text: "Intelligent analysis recommendations and automated insights based on your data characteristics"
        theme_text_color: "Secondary"
        font_style: "Body"
        role: "medium"
        text_size: self.width, None
        size_hint_y: None
        height: dp(80)
    
    MDBoxLayout:
        orientation: 'horizontal'
        spacing: dp(8)
        size_hint_y: None
        height: dp(40)
        
        MDButton:
            text: "Auto Analyze"
            style: "filled"
            size_hint_x: 1
            theme_bg_color: "Custom"
            md_bg_color: 0.2, 0.8, 0.6, 1
            on_release: app.root.get_screen('analytics').navigate_to_auto_detection()
        
        MDIconButton:
            icon: "arrow-right"
            theme_icon_color: "Custom"
            icon_color: 0.2, 0.8, 0.6, 1
            size_hint_x: None
            width: dp(40)
            disabled: True

<DescriptiveAnalyticsNavigationCard@MDCard>:
    orientation: 'vertical'
    size_hint_y: None
    height: dp(220)
    elevation: 3
    md_bg_color: 1.0, 0.98, 0.99, 1
    radius: [16, 16, 16, 16]
    padding: [dp(20), dp(16), dp(20), dp(16)]
    spacing: dp(12)
    ripple_behavior: True
    on_release: app.root.get_screen('analytics').navigate_to_descriptive_analytics()
    
    MDBoxLayout:
        orientation: 'horizontal'
        spacing: dp(12)
        size_hint_y: None
        height: dp(48)
        
        MDIconButton:
            icon: "chart-bar"
            theme_icon_color: "Custom"
            icon_color: 0.8, 0.2, 0.6, 1
            disabled: True
            size_hint_x: None
            width: dp(48)
            icon_size: "32dp"
        
        MDLabel:
            text: "Descriptive Analytics"
            theme_text_color: "Primary"
            font_style: "Headline"
            role: "small"
            bold: True
            pos_hint: {"center_y": 0.5}
    
    MDLabel:
        text: "Comprehensive statistical analysis including distributions, correlations, and data quality assessment"
        theme_text_color: "Secondary"
        font_style: "Body"
        role: "medium"
        text_size: self.width, None
        size_hint_y: None
        height: dp(80)
    
    MDBoxLayout:
        orientation: 'horizontal'
        spacing: dp(8)
        size_hint_y: None
        height: dp(40)
        
        MDButton:
            text: "Run Analysis"
            style: "filled"
            size_hint_x: 1
            theme_bg_color: "Custom"
            md_bg_color: 0.8, 0.2, 0.6, 1
            on_release: app.root.get_screen('analytics').navigate_to_descriptive_analytics()
        
        MDIconButton:
            icon: "arrow-right"
            theme_icon_color: "Custom"
            icon_color: 0.8, 0.2, 0.6, 1
            size_hint_x: None
            width: dp(40)
            disabled: True

<InferentialAnalyticsNavigationCard@MDCard>:
    orientation: 'vertical'
    size_hint_y: None
    height: dp(220)
    elevation: 3
    md_bg_color: 0.96, 0.98, 1.0, 1
    radius: [16, 16, 16, 16]
    padding: [dp(20), dp(16), dp(20), dp(16)]
    spacing: dp(12)
    ripple_behavior: True
    on_release: app.root.get_screen('analytics').navigate_to_inferential_analytics()
    
    MDBoxLayout:
        orientation: 'horizontal'
        spacing: dp(12)
        size_hint_y: None
        height: dp(48)
        
        MDIconButton:
            icon: "chart-scatter-plot"
            theme_icon_color: "Custom"
            icon_color: 0.2, 0.4, 0.8, 1
            disabled: True
            size_hint_x: None
            width: dp(48)
            icon_size: "32dp"
        
        MDLabel:
            text: "Inferential Analytics"
            theme_text_color: "Primary"
            font_style: "Headline"
            role: "small"
            bold: True
            pos_hint: {"center_y": 0.5}
    
    MDLabel:
        text: "Statistical hypothesis testing, regression analysis, ANOVA, Bayesian methods, and advanced statistical inference"
        theme_text_color: "Secondary"
        font_style: "Body"
        role: "medium"
        text_size: self.width, None
        size_hint_y: None
        height: dp(80)
    
    MDBoxLayout:
        orientation: 'horizontal'
        spacing: dp(8)
        size_hint_y: None
        height: dp(40)
        
        MDButton:
            text: "Run Analysis"
            style: "filled"
            size_hint_x: 1
            theme_bg_color: "Custom"
            md_bg_color: 0.2, 0.4, 0.8, 1
            on_release: app.root.get_screen('analytics').navigate_to_inferential_analytics()
        
        MDIconButton:
            icon: "arrow-right"
            theme_icon_color: "Custom"
            icon_color: 0.2, 0.4, 0.8, 1
            size_hint_x: None
            width: dp(40)
            disabled: True

<QualitativeAnalyticsNavigationCard@MDCard>:
    orientation: 'vertical'
    size_hint_y: None
    height: dp(220)
    elevation: 3
    md_bg_color: 0.99, 0.98, 1.0, 1
    radius: [16, 16, 16, 16]
    padding: [dp(20), dp(16), dp(20), dp(16)]
    spacing: dp(12)
    ripple_behavior: True
    on_release: app.root.get_screen('analytics').navigate_to_qualitative_analytics()
    
    MDBoxLayout:
        orientation: 'horizontal'
        spacing: dp(12)
        size_hint_y: None
        height: dp(48)
        
        MDIconButton:
            icon: "text-box"
            theme_icon_color: "Custom"
            icon_color: 0.6, 0.2, 0.8, 1
            disabled: True
            size_hint_x: None
            width: dp(48)
            icon_size: "32dp"
        
        MDLabel:
            text: "Qualitative Analytics"
            theme_text_color: "Primary"
            font_style: "Headline"
            role: "small"
            bold: True
            pos_hint: {"center_y": 0.5}
    
    MDLabel:
        text: "Advanced text analysis with sentiment detection, theme extraction, and qualitative insights"
        theme_text_color: "Secondary"
        font_style: "Body"
        role: "medium"
        text_size: self.width, None
        size_hint_y: None
        height: dp(80)
    
    MDBoxLayout:
        orientation: 'horizontal'
        spacing: dp(8)
        size_hint_y: None
        height: dp(40)
        
        MDButton:
            text: "Analyze Text"
            style: "filled"
            size_hint_x: 1
            theme_bg_color: "Custom"
            md_bg_color: 0.6, 0.2, 0.8, 1
            on_release: app.root.get_screen('analytics').navigate_to_qualitative_analytics()
        
        MDIconButton:
            icon: "arrow-right"
            theme_icon_color: "Custom"
            icon_color: 0.6, 0.2, 0.8, 1
            size_hint_x: None
            width: dp(40)
            disabled: True

# Analytics Card Components
<AnalyticsCard@MDCard>:
    orientation: 'vertical'
    size_hint_y: None
    height: dp(300)
    elevation: 3
    radius: [16, 16, 16, 16]
    padding: [dp(24), dp(20), dp(24), dp(20)]
    spacing: dp(16)

# Note: StatCard is defined in widgets/stat_card.py and kv/stat_card.kv

# Welcome Message Card (shown when no project selected)
<AnalyticsWelcomeCard@MDCard>:
    orientation: 'vertical'  
    size_hint_y: None
    height: dp(300)
    elevation: 2
    radius: [16, 16, 16, 16]
    padding: [dp(32), dp(24), dp(32), dp(24)]
    spacing: dp(20)
    md_bg_color: 0.98, 0.99, 1.0, 1
    
    MDIconButton:
        icon: "chart-line"
        theme_icon_color: "Custom"
        icon_color: 0.4, 0.6, 1.0, 1
        size_hint: None, None
        size: dp(64), dp(64)
        icon_size: "48dp"
        pos_hint: {'center_x': 0.5}
        disabled: True
    
    MDLabel:
        text: "Analytics Hub"
        font_style: "Headline"
        role: "large"
        text_size: self.width, None
        theme_text_color: "Primary"
        halign: "center"
        bold: True
        size_hint_y: None
        height: dp(48)
    
    MDLabel:
        text: "Select a project above to access powerful analytics features for your survey data"
        font_style: "Body"
        role: "large"
        theme_text_color: "Secondary"
        halign: "center"
        text_size: self.width, None
        size_hint_y: None
        height: dp(80)
    
    MDButton:
        style: "filled"
        size_hint: None, None
        height: dp(48)
        width: dp(200)
        md_bg_color: 0.4, 0.6, 1.0, 1
        pos_hint: {"center_x": 0.5}
        on_release: app.root.get_screen('analytics').navigate_to_projects()
        
        MDButtonText:
            text: "Go to Projects"
            font_size: "16sp"

# Button Components
<AnalysisButton@MDButton>:
    style: "filled"
    size_hint_y: None
    height: dp(48)
    elevation: 2
    
    MDButtonText:
        font_size: "16sp"

<IconButton@MDIconButton>:
    size_hint: None, None
    size: dp(48), dp(48)
    icon_size: "20dp"

# Grid Layout Components
<AnalysisGrid@GridLayout>:
    cols: 2
    spacing: dp(20)
    size_hint_y: None
    adaptive_height: True

<StatsGrid@GridLayout>:
    cols: 4
    spacing: dp(16)
    size_hint_y: None
    height: dp(120)

# Menu Item Components
<MenuItem@MDListItem>:
    size_hint_y: None
    height: dp(56)
    
    MDListItemHeadlineText:
        text: ""
        font_size: "16sp"

<TwoLineMenuItem@MDListItem>:
    size_hint_y: None
    height: dp(72)
    
    MDListItemHeadlineText:
        text: ""
        font_size: "16sp"
    
    MDListItemSupportingText:
        text: ""
        font_size: "14sp"

# Dialog Components
<AnalysisDialog@MDDialog>:
    size_hint: 0.85, 0.8
    elevation: 6

<ScrollDialog@MDScrollView>:
    size_hint: 1, 1
    bar_width: dp(8)

# Color Scheme
<ColorScheme>:
    primary_color: 0.2, 0.6, 1.0, 1
    secondary_color: 0.2, 0.8, 0.6, 1
    accent_color: 1.0, 0.6, 0.2, 1
    error_color: 0.8, 0.2, 0.2, 1
    success_color: 0.2, 0.8, 0.2, 1
    warning_color: 0.8, 0.6, 0.2, 1

# Text Styles
<TextStyles>:
    font_size_h1: "32sp"
    font_size_h2: "28sp"
    font_size_h3: "24sp"
    font_size_h4: "20sp"
    font_size_h5: "18sp"
    font_size_h6: "16sp"
    font_size_body1: "16sp"
    font_size_body2: "14sp"
    font_size_button: "16sp"
    font_size_caption: "12sp"