#:kivy 2.0
#:import MDCard kivymd.uix.card.MDCard
#:import MDScrollView kivymd.uix.scrollview.MDScrollView
#:import MDLabel kivymd.uix.label.MDLabel
#:import MDButton kivymd.uix.button.MDButton
#:import MDIconButton kivymd.uix.button.MDIconButton
#:import MDBoxLayout kivymd.uix.boxlayout.MDBoxLayout
#:import MDTextField kivymd.uix.textfield.MDTextField
#:import MDCheckbox kivymd.uix.selectioncontrol.MDCheckbox
#:import MDDropdownMenu kivymd.uix.menu.MDDropdownMenu
#:import MDCircularProgressIndicator kivymd.uix.progressindicator.MDCircularProgressIndicator
#:import MDDialog kivymd.uix.dialog.MDDialog
#:import MDDialogHeadlineText kivymd.uix.dialog.MDDialogHeadlineText
#:import MDDialogSupportingText kivymd.uix.dialog.MDDialogSupportingText
#:import MDDialogButtonContainer kivymd.uix.dialog.MDDialogButtonContainer
#:import GridLayout kivy.uix.gridlayout.GridLayout
#:import dp kivy.metrics.dp

# Main Descriptive Analytics Screen Layout
<DescriptiveAnalyticsScreen>:
    name: 'descriptive_analytics'
    
    MDScrollView:
        MDBoxLayout:
            id: main_content
            orientation: 'vertical'
            spacing: dp(16)
            padding: [dp(24), dp(8), dp(24), dp(20)]
            size_hint_y: None
            height: self.minimum_height
            
            # Top Navigation Bar
            TopBar:
                id: top_bar
                size_hint_y: None
                height: dp(56)
            
            # Project Selection Card
            DescriptiveProjectCard:
                id: project_selection_card
            
            # Analysis Controls Card
            DescriptiveControlsCard:
                id: analysis_controls_card
            
            # Analysis Options Card
            DescriptiveOptionsCard:
                id: analysis_options_card
            
            # Sample Size Recommendations Card
            DescriptiveSampleSizeCard:
                id: sample_size_card
            
            # Analysis Results Card
            DescriptiveResultsCard:
                id: results_card
            
            # Action Buttons Card
            DescriptiveActionsCard:
                id: actions_card
    
    # Dialog instances (invisible until opened)
    AdvancedAnalysisDialog:
        id: advanced_analysis_dialog
    
    GeospatialAnalysisDialog:
        id: geospatial_dialog
    
    TemporalAnalysisDialog:
        id: temporal_dialog
    
    CrossTabulationDialog:
        id: cross_tabulation_dialog
    
    WeightedStatsDialog:
        id: weighted_stats_dialog
    
    ExportOptionsDialog:
        id: export_options_dialog

# Project Selection Card Component
<DescriptiveProjectCard@MDCard>:
    orientation: 'horizontal'
    size_hint_y: None
    height: dp(64)
    elevation: 2
    md_bg_color: 0.98, 0.99, 1.0, 1
    radius: [12, 12, 12, 12]
    padding: [dp(20), dp(12), dp(20), dp(12)]
    spacing: dp(16)
    
    # Title Section
    MDBoxLayout:
        orientation: 'horizontal'
        spacing: dp(12)
        size_hint_x: 0.4
        
        MDIconButton:
            icon: "chart-histogram"
            theme_icon_color: "Custom"
            icon_color: app.theme_cls.primaryColor
            size_hint_x: None
            width: dp(36)
            icon_size: "20dp"
            disabled: True
        
        MDLabel:
            text: "Descriptive Analytics"
            theme_text_color: "Primary"
            font_style: "Headline"
            role: "small"
            bold: True
            halign: "left"
            valign: "center"
    
    # Project Selector
    MDButton:
        id: project_selector
        text: "Select Project"
        style: "filled"
        size_hint_x: 0.4
        theme_bg_color: "Custom"
        md_bg_color: app.theme_cls.primaryColor
        on_release: root.show_project_menu()
    
    # Analysis Status
    MDLabel:
        id: analysis_status_label
        text: "Status: Ready"
        theme_text_color: "Secondary"
        font_style: "Body"
        role: "medium"
        size_hint_x: 0.2
        halign: "right"
        valign: "center"

# Analysis Controls Card Component
<DescriptiveControlsCard@MDCard>:
    orientation: 'vertical'
    size_hint_y: None
    height: dp(180)
    elevation: 3
    md_bg_color: 0.98, 0.99, 1.0, 1
    radius: [12, 12, 12, 12]
    padding: [dp(16), dp(16), dp(16), dp(16)]
    spacing: dp(12)
    
    # Header
    MDBoxLayout:
        orientation: 'horizontal'
        spacing: dp(12)
        size_hint_y: None
        height: dp(36)
        
        MDIconButton:
            icon: "play-circle"
            theme_icon_color: "Custom"
            icon_color: 0.2, 0.7, 0.2, 1
            disabled: True
            size_hint: None, None
            size: dp(32), dp(32)
        
        MDLabel:
            text: "Analysis Controls"
            theme_text_color: "Primary"
            font_style: "Headline"
            role: "small"
            bold: True
            size_hint_y: None
            height: dp(36)
        
        MDLabel:
            id: analysis_count_label
            text: "0 analyses completed"
            theme_text_color: "Secondary"
            font_style: "Body"
            role: "medium"
            halign: "right"
            size_hint_y: None
            height: dp(36)
    
    # Main analysis button
    MDButton:
        text: "Run Descriptive Analysis"
        style: "filled"
        size_hint_y: None
        height: dp(48)
        theme_bg_color: "Custom"
        md_bg_color: 0.2, 0.7, 0.2, 1
        on_release: root.run_descriptive_analysis()
    
    # Quick analysis buttons row
    MDBoxLayout:
        orientation: 'horizontal'
        spacing: dp(8)
        size_hint_y: None
        height: dp(40)
        
        MDButton:
            text: "Basic Stats"
            style: "outlined"
            size_hint_x: 0.2
            theme_outline_color: "Custom"
            line_color: app.theme_cls.primaryColor
            on_release: root.run_basic_statistics()
        
        MDButton:
            text: "Distribution"
            style: "outlined"
            size_hint_x: 0.2
            theme_outline_color: "Custom"
            line_color: app.theme_cls.primaryColor
            on_release: root.run_distribution_analysis_extended()
        
        MDButton:
            text: "Categorical"
            style: "outlined"
            size_hint_x: 0.2
            theme_outline_color: "Custom"
            line_color: app.theme_cls.primaryColor
            on_release: root.run_categorical_analysis_extended()
        
        MDButton:
            text: "Outliers"
            style: "outlined"
            size_hint_x: 0.2
            theme_outline_color: "Custom"
            line_color: app.theme_cls.primaryColor
            on_release: root.run_outlier_analysis()
        
        MDButton:
            text: "More"
            style: "text"
            size_hint_x: 0.2
            theme_text_color: "Custom"
            text_color: app.theme_cls.primaryColor
            on_release: root.show_analysis_options_dialog()
    
    # Variable selection row
    MDBoxLayout:
        orientation: 'horizontal'
        spacing: dp(8)
        size_hint_y: None
        height: dp(32)
        
        MDButton:
            text: "Select Variables"
            style: "text"
            size_hint_x: 0.3
            theme_text_color: "Custom"
            text_color: app.theme_cls.primaryColor
            on_release: root.show_variable_selection_dialog()
        
        MDLabel:
            id: variable_selection_info_label
            text: "0/0 variables selected"
            theme_text_color: "Secondary"
            font_style: "Body"
            role: "small"
            size_hint_x: 0.4
            halign: "center"
        
        MDButton:
            text: "Comprehensive Report"
            style: "text"
            size_hint_x: 0.2
            theme_text_color: "Custom"
            text_color: 0.8, 0.6, 0.2, 1
            on_release: root.run_comprehensive_report()
        
        MDButton:
            text: "Executive Summary"
            style: "text"
            size_hint_x: 0.1
            theme_text_color: "Custom"
            text_color: 0.6, 0.4, 0.8, 1
            on_release: root.generate_executive_summary()

# Analysis Options Card Component
<DescriptiveOptionsCard@MDCard>:
    orientation: 'vertical'
    size_hint_y: None
    height: dp(420)
    elevation: 2
    md_bg_color: 0.97, 0.98, 1.0, 1
    radius: [12, 12, 12, 12]
    padding: [dp(16), dp(16), dp(16), dp(16)]
    spacing: dp(12)
    
    # Header
    MDBoxLayout:
        orientation: 'horizontal'
        spacing: dp(12)
        size_hint_y: None
        height: dp(36)
        
        MDIconButton:
            icon: "format-list-bulleted"
            theme_icon_color: "Custom"
            icon_color: 0.13, 0.59, 0.95, 1
            disabled: True
            size_hint: None, None
            size: dp(32), dp(32)
        
        MDLabel:
            text: "Analysis Options"
            theme_text_color: "Primary"
            font_style: "Headline"
            role: "small"
            bold: True
    
    # Analysis options grid
    MDScrollView:
        do_scroll_x: False
        do_scroll_y: True
        bar_width: dp(8)
        
        GridLayout:
            id: analysis_options_grid
            cols: 3
            spacing: dp(8)
            size_hint_y: None
            height: self.minimum_height
            padding: [dp(4), dp(4), dp(4), dp(4)]
            
            # Basic Statistics Option
            DescriptiveAnalysisOptionCard:
                option_title: "Basic Statistics"
                option_description: "Mean, median, standard deviation, and other basic statistics"
                option_icon: "calculator"
                option_color: 0.2, 0.6, 1.0, 1
                on_release: root.run_basic_statistics()
            
            # Distribution Analysis Option
            DescriptiveAnalysisOptionCard:
                option_title: "Distribution Analysis"
                option_description: "Analyze data distributions and patterns"
                option_icon: "chart-bell-curve"
                option_color: 0.8, 0.6, 0.2, 1
                on_release: root.run_distribution_analysis_extended()
            
            # Categorical Analysis Option
            DescriptiveAnalysisOptionCard:
                option_title: "Categorical Analysis"
                option_description: "Frequency tables and cross-tabulations"
                option_icon: "view-list"
                option_color: 0.2, 0.8, 0.6, 1
                on_release: root.run_categorical_analysis_extended()
            
            # Outlier Detection Option
            DescriptiveAnalysisOptionCard:
                option_title: "Outlier Detection"
                option_description: "Identify unusual data points"
                option_icon: "target"
                option_color: 0.8, 0.2, 0.2, 1
                on_release: root.run_outlier_analysis()
            
            # Missing Data Analysis Option
            DescriptiveAnalysisOptionCard:
                option_title: "Missing Data"
                option_description: "Analyze patterns of missing data"
                option_icon: "help-circle"
                option_color: 0.6, 0.6, 0.6, 1
                on_release: root.run_missing_data_analysis()
            
            # Data Quality Assessment Option
            DescriptiveAnalysisOptionCard:
                option_title: "Data Quality"
                option_description: "Comprehensive data quality assessment"
                option_icon: "check-circle"
                option_color: 0.2, 0.8, 0.4, 1
                on_release: root.run_data_quality_analysis()
            
            # Geospatial Analysis Option
            DescriptiveAnalysisOptionCard:
                option_title: "Geospatial Analysis"
                option_description: "Spatial distribution and clustering analysis"
                option_icon: "map-marker"
                option_color: 0.8, 0.4, 0.6, 1
                on_release: root.show_geospatial_dialog()
            
            # Temporal Analysis Option
            DescriptiveAnalysisOptionCard:
                option_title: "Temporal Analysis"
                option_description: "Time series and seasonality analysis"
                option_icon: "clock-outline"
                option_color: 0.6, 0.8, 0.4, 1
                on_release: root.show_temporal_dialog()
            
            # Cross-Tabulation Option
            DescriptiveAnalysisOptionCard:
                option_title: "Cross-Tabulation"
                option_description: "Chi-square tests and association measures"
                option_icon: "table"
                option_color: 0.4, 0.6, 0.8, 1
                on_release: root.show_cross_tabulation_dialog()
            
            # Normality Testing Option
            DescriptiveAnalysisOptionCard:
                option_title: "Normality Tests"
                option_description: "Comprehensive normality testing"
                option_icon: "chart-bell-curve-cumulative"
                option_color: 0.8, 0.6, 0.4, 1
                on_release: root.run_normality_tests()
            
            # Distribution Fitting Option
            DescriptiveAnalysisOptionCard:
                option_title: "Distribution Fitting"
                option_description: "Fit statistical distributions to data"
                option_icon: "chart-multiline"
                option_color: 0.4, 0.8, 0.8, 1
                on_release: root.run_distribution_fitting()
            
            # Advanced Analytics Button
            DescriptiveAnalysisOptionCard:
                option_title: "Advanced Analytics"
                option_description: "Access all advanced analysis methods"
                option_icon: "cog"
                option_color: 0.6, 0.4, 0.8, 1
                on_release: root.show_advanced_analysis_menu()

# Sample Size Recommendations Card Component
<DescriptiveSampleSizeCard@MDCard>:
    orientation: 'vertical'
    size_hint_y: None
    height: dp(200)
    elevation: 2
    md_bg_color: 0.98, 1.0, 0.98, 1
    radius: [12, 12, 12, 12]
    padding: [dp(16), dp(16), dp(16), dp(16)]
    spacing: dp(12)
    
    # Header
    MDBoxLayout:
        orientation: 'horizontal'
        spacing: dp(12)
        size_hint_y: None
        height: dp(36)
        
        MDIconButton:
            icon: "account-group"
            theme_icon_color: "Custom"
            icon_color: 0.8, 0.6, 0.2, 1
            disabled: True
            size_hint: None, None
            size: dp(32), dp(32)
        
        MDLabel:
            text: "Sample Size Recommendations"
            theme_text_color: "Primary"
            font_style: "Headline"
            role: "small"
            bold: True
        
        MDButton:
            text: "Show Details"
            style: "text"
            size_hint_x: None
            width: dp(100)
            theme_text_color: "Custom"
            text_color: app.theme_cls.primaryColor
            on_release: root.show_sample_size_recommendations()
    
    # Sample size content
    MDScrollView:
        id: sample_size_content
        do_scroll_x: False
        do_scroll_y: True
        bar_width: dp(8)
        
        MDBoxLayout:
            id: sample_size_list
            orientation: 'vertical'
            spacing: dp(8)
            size_hint_y: None
            height: self.minimum_height
            
            # Default message when no recommendations
            MDLabel:
                text: "Select a project to see sample size recommendations"
                theme_text_color: "Secondary"
                font_style: "Body"
                role: "medium"
                halign: "center"
                size_hint_y: None
                height: dp(100)

# Analysis Results Card Component
<DescriptiveResultsCard@MDCard>:
    orientation: 'vertical'
    size_hint_y: None
    height: dp(500)
    elevation: 2
    md_bg_color: 1, 1, 1, 1
    radius: [12, 12, 12, 12]
    padding: [dp(16), dp(16), dp(16), dp(16)]
    spacing: dp(12)
    
    # Header
    MDBoxLayout:
        orientation: 'horizontal'
        spacing: dp(12)
        size_hint_y: None
        height: dp(36)
        
        MDIconButton:
            icon: "chart-box"
            theme_icon_color: "Custom"
            icon_color: app.theme_cls.primaryColor
            disabled: True
            size_hint: None, None
            size: dp(32), dp(32)
        
        MDLabel:
            text: "Analysis Results"
            theme_text_color: "Primary"
            font_style: "Headline"
            role: "small"
            bold: True
        
        # Result type tabs
        MDScrollView:
            do_scroll_x: True
            do_scroll_y: False
            size_hint_x: 0.6
            
            MDBoxLayout:
                orientation: 'horizontal'
                spacing: dp(4)
                size_hint_x: None
                width: self.minimum_width
                
                MDButton:
                    id: statistics_tab
                    text: "Statistics"
                    style: "text"
                    size_hint_x: None
                    width: dp(80)
                    theme_text_color: "Custom"
                    text_color: app.theme_cls.primaryColor
                    on_release: root.switch_results_tab("statistics")
                
                MDButton:
                    id: distribution_tab
                    text: "Distribution"
                    style: "text"
                    size_hint_x: None
                    width: dp(90)
                    theme_text_color: "Custom"
                    text_color: 0.6, 0.6, 0.6, 1
                    on_release: root.switch_results_tab("distribution")
                
                MDButton:
                    id: categorical_tab
                    text: "Categorical"
                    style: "text"
                    size_hint_x: None
                    width: dp(90)
                    theme_text_color: "Custom"
                    text_color: 0.6, 0.6, 0.6, 1
                    on_release: root.switch_results_tab("categorical")
                
                MDButton:
                    id: geospatial_tab
                    text: "Geospatial"
                    style: "text"
                    size_hint_x: None
                    width: dp(80)
                    theme_text_color: "Custom"
                    text_color: 0.6, 0.6, 0.6, 1
                    on_release: root.switch_results_tab("geospatial")
                
                MDButton:
                    id: temporal_tab
                    text: "Temporal"
                    style: "text"
                    size_hint_x: None
                    width: dp(70)
                    theme_text_color: "Custom"
                    text_color: 0.6, 0.6, 0.6, 1
                    on_release: root.switch_results_tab("temporal")
                
                MDButton:
                    id: quality_tab
                    text: "Quality"
                    style: "text"
                    size_hint_x: None
                    width: dp(60)
                    theme_text_color: "Custom"
                    text_color: 0.6, 0.6, 0.6, 1
                    on_release: root.switch_results_tab("quality")
                
                MDButton:
                    id: report_tab
                    text: "Report"
                    style: "text"
                    size_hint_x: None
                    width: dp(60)
                    theme_text_color: "Custom"
                    text_color: 0.6, 0.6, 0.6, 1
                    on_release: root.switch_results_tab("report")
    
    # Results content
    MDScrollView:
        id: results_content
        do_scroll_x: False
        do_scroll_y: True
        bar_width: dp(8)
        
        MDBoxLayout:
            id: results_display
            orientation: 'vertical'
            spacing: dp(12)
            size_hint_y: None
            height: self.minimum_height
            
            # Default message when no results
            DescriptiveEmptyResults:

# Action Buttons Card Component
<DescriptiveActionsCard@MDCard>:
    orientation: 'horizontal'
    size_hint_y: None
    height: dp(80)
    elevation: 2
    md_bg_color: 0.96, 0.96, 0.96, 1
    radius: [12, 12, 12, 12]
    padding: [dp(16), dp(12), dp(16), dp(12)]
    spacing: dp(12)
    
    # Export actions
    MDBoxLayout:
        orientation: 'horizontal'
        spacing: dp(8)
        size_hint_x: 0.6
        
        MDButton:
            text: "Export JSON"
            style: "filled"
            size_hint_x: 0.33
            theme_bg_color: "Custom"
            md_bg_color: 0.2, 0.6, 0.8, 1
            on_release: root.export_to_json()
        
        MDButton:
            text: "Export CSV"
            style: "outlined"
            size_hint_x: 0.33
            theme_outline_color: "Custom"
            line_color: 0.2, 0.6, 0.8, 1
            on_release: root.export_to_csv()
        
        MDButton:
            text: "Export Report"
            style: "text"
            size_hint_x: 0.34
            theme_text_color: "Custom"
            text_color: 0.2, 0.6, 0.8, 1
            on_release: root.show_export_options_dialog()
    
    # Analysis actions
    MDBoxLayout:
        orientation: 'horizontal'
        spacing: dp(8)
        size_hint_x: 0.4
        
        MDButton:
            text: "Clear Results"
            style: "text"
            size_hint_x: 0.5
            theme_text_color: "Custom"
            text_color: 0.8, 0.4, 0.4, 1
            on_release: root.clear_results()
        
        MDButton:
            text: "Export Sample Analysis"
            style: "text"
            size_hint_x: 0.5
            theme_text_color: "Custom"
            text_color: 0.6, 0.6, 0.6, 1
            on_release: root.export_sample_size_analysis()

# Analysis Option Card Component
<DescriptiveAnalysisOptionCard@MDCard>:
    option_title: ""
    option_description: ""
    option_icon: ""
    option_color: 0.5, 0.5, 0.5, 1
    
    orientation: 'vertical'
    size_hint_y: None
    height: dp(100)
    elevation: 1
    md_bg_color: 0.99, 0.99, 0.99, 1
    radius: [8, 8, 8, 8]
    padding: [dp(12), dp(8), dp(12), dp(8)]
    spacing: dp(4)
    
    MDBoxLayout:
        orientation: 'horizontal'
        spacing: dp(8)
        size_hint_y: None
        height: dp(32)
        
        MDIconButton:
            icon: root.option_icon
            theme_icon_color: "Custom"
            icon_color: root.option_color
            disabled: True
            size_hint: None, None
            size: dp(24), dp(24)
        
        MDLabel:
            text: root.option_title
            theme_text_color: "Primary"
            font_style: "Body"
            role: "medium"
            bold: True
            size_hint_y: None
            height: dp(32)
    
    MDLabel:
        text: root.option_description
        theme_text_color: "Secondary"
        font_style: "Body"
        role: "small"
        text_size: self.width, None
        size_hint_y: None
        height: dp(56)

# Variable Selection Dialog
<VariableSelectionDialog@MDDialog>:
    id: variable_selection_dialog
    
    MDDialogHeadlineText:
        text: "Select Variables for Analysis"
    
    MDDialogSupportingText:
        text: "Choose the variables you want to include in the descriptive analysis"
    
    MDScrollView:
        size_hint_y: None
        height: dp(300)
        
        MDBoxLayout:
            orientation: 'vertical'
            spacing: dp(8)
            size_hint_y: None
            height: self.minimum_height
            padding: [dp(16), dp(16), dp(16), dp(16)]
            
            # Select all/none buttons
            MDBoxLayout:
                orientation: 'horizontal'
                spacing: dp(8)
                size_hint_y: None
                height: dp(32)
                
                MDButton:
                    text: "Select All"
                    style: "text"
                    size_hint_x: 0.5
                    theme_text_color: "Custom"
                    text_color: app.theme_cls.primaryColor
                    on_release: root.select_all_variables()
                
                MDButton:
                    text: "Clear All"
                    style: "text"
                    size_hint_x: 0.5
                    theme_text_color: "Custom"
                    text_color: 0.6, 0.6, 0.6, 1
                    on_release: root.clear_variable_selection()
            
            # Variables list (populated dynamically)
            MDBoxLayout:
                id: variables_list
                orientation: 'vertical'
                spacing: dp(4)
                size_hint_y: None
                height: self.minimum_height
    
    MDDialogButtonContainer:
        MDButton:
            text: "Cancel"
            style: "text"
            on_release: variable_selection_dialog.dismiss()
        
        MDButton:
            text: "Run Analysis"
            style: "filled"
            theme_bg_color: "Custom"
            md_bg_color: app.theme_cls.primaryColor
            on_release: root.run_analysis_with_selected_variables()

# Analysis Options Dialog
<AnalysisOptionsDialog@MDDialog>:
    id: analysis_options_dialog
    
    MDDialogHeadlineText:
        text: "Analysis Options"
    
    MDDialogSupportingText:
        text: "Choose from available descriptive analysis types"
    
    MDBoxLayout:
        orientation: 'vertical'
        spacing: dp(8)
        size_hint_y: None
        height: dp(400)
        padding: [dp(16), dp(16), dp(16), dp(16)]
        
        # Analysis option buttons
        MDButton:
            text: "Missing Data Analysis"
            style: "outlined"
            size_hint_y: None
            height: dp(48)
            theme_outline_color: "Custom"
            line_color: 0.6, 0.6, 0.6, 1
            on_release: root.run_missing_data_analysis()
        
        MDButton:
            text: "Data Quality Assessment"
            style: "outlined"
            size_hint_y: None
            height: dp(48)
            theme_outline_color: "Custom"
            line_color: 0.2, 0.8, 0.4, 1
            on_release: root.run_data_quality_analysis()
        
        MDButton:
            text: "Comprehensive Report"
            style: "outlined"
            size_hint_y: None
            height: dp(48)
            theme_outline_color: "Custom"
            line_color: 0.8, 0.6, 0.2, 1
            on_release: root.run_comprehensive_report()
        
        MDButton:
            text: "Custom Variable Analysis"
            style: "text"
            size_hint_y: None
            height: dp(48)
            theme_text_color: "Custom"
            text_color: 0.6, 0.6, 0.6, 1
            on_release: root.show_variable_selection_dialog()
    
    MDDialogButtonContainer:
        MDButton:
            text: "Close"
            style: "text"
            on_release: analysis_options_dialog.dismiss()

# Analysis Results Dialog
<AnalysisResultsDialog@MDDialog>:
    id: results_dialog
    
    MDDialogHeadlineText:
        id: results_dialog_title
        text: "Analysis Results"
    
    MDScrollView:
        size_hint_y: None
        height: dp(400)
        
        MDBoxLayout:
            orientation: 'vertical'
            spacing: dp(12)
            size_hint_y: None
            height: self.minimum_height
            padding: [dp(16), dp(16), dp(16), dp(16)]
            
            MDLabel:
                id: results_dialog_content
                text: "Results will appear here"
                theme_text_color: "Primary"
                font_style: "Body"
                role: "medium"
                text_size: self.width, None
    
    MDDialogButtonContainer:
        MDButton:
            text: "Export"
            style: "text"
            theme_text_color: "Custom"
            text_color: app.theme_cls.primaryColor
            on_release: root.export_results()
        
        MDButton:
            text: "Close"
            style: "filled"
            theme_bg_color: "Custom"
            md_bg_color: app.theme_cls.primaryColor
            on_release: results_dialog.dismiss()

# Sample Size Recommendation Item Component
<SampleSizeRecommendationItem@MDCard>:
    test_type: ""
    current_size: ""
    adequacy: ""
    recommendation: ""
    
    orientation: 'vertical'
    size_hint_y: None
    height: dp(80)
    elevation: 1
    md_bg_color: 0.99, 0.99, 0.99, 1
    radius: [8, 8, 8, 8]
    padding: [dp(12), dp(8), dp(12), dp(8)]
    spacing: dp(4)
    
    MDBoxLayout:
        orientation: 'horizontal'
        spacing: dp(8)
        size_hint_y: None
        height: dp(24)
        
        MDLabel:
            text: root.test_type
            theme_text_color: "Primary"
            font_style: "Body"
            role: "medium"
            bold: True
            size_hint_x: 0.7
        
        MDLabel:
            text: f"Size: {root.current_size}"
            theme_text_color: "Secondary"
            font_style: "Body"
            role: "small"
            size_hint_x: 0.3
            halign: "right"
    
    MDLabel:
        text: root.recommendation
        theme_text_color: "Secondary"
        font_style: "Body"
        role: "small"
        text_size: self.width, None
        size_hint_y: None
        height: dp(44)

# Empty Results State Component
<DescriptiveEmptyResults@MDBoxLayout>:
    orientation: 'vertical'
    spacing: dp(20)
    size_hint_y: None
    height: dp(300)
    padding: [dp(40), dp(30), dp(40), dp(30)]
    
    MDIconButton:
        icon: "chart-box-outline"
        theme_icon_color: "Custom"
        icon_color: 0.6, 0.6, 0.6, 1
        disabled: True
        size_hint: None, None
        size: dp(48), dp(48)
        pos_hint: {'center_x': 0.5}
    
    MDLabel:
        text: "No descriptive analysis results yet"
        theme_text_color: "Secondary"
        font_style: "Headline"
        role: "small"
        halign: "center"
    
    MDLabel:
        text: "Select a project and run descriptive analysis to see statistical insights"
        theme_text_color: "Hint"
        font_style: "Body"
        role: "medium"
        halign: "center"
        text_size: dp(300), None

# Loading State Component
<DescriptiveLoadingCard@MDCard>:
    orientation: 'vertical'
    size_hint_y: None
    height: dp(300)
    elevation: 3
    md_bg_color: 0.97, 0.98, 1.0, 1
    radius: [12, 12, 12, 12]
    padding: [dp(40), dp(30), dp(40), dp(30)]
    spacing: dp(24)
    
    MDCircularProgressIndicator:
        size_hint: None, None
        size: dp(48), dp(48)
        pos_hint: {'center_x': 0.5}
    
    MDLabel:
        text: "Running descriptive analysis..."
        theme_text_color: "Secondary"
        font_style: "Headline"
        role: "small"
        halign: "center"
    
    MDLabel:
        text: "Please wait while we calculate statistical measures"
        theme_text_color: "Hint"
        font_style: "Body"
        role: "medium"
        halign: "center"

# Error State Component
<DescriptiveErrorCard@MDCard>:
    error_message: ""
    
    orientation: 'vertical'
    size_hint_y: None
    height: dp(300)
    elevation: 3
    md_bg_color: 1.0, 0.96, 0.96, 1
    radius: [12, 12, 12, 12]
    padding: [dp(40), dp(30), dp(40), dp(30)]
    spacing: dp(24)
    
    MDIconButton:
        icon: "alert-circle-outline"
        theme_icon_color: "Custom"
        icon_color: 0.8, 0.2, 0.2, 1
        disabled: True
        size_hint: None, None
        size: dp(64), dp(64)
        pos_hint: {'center_x': 0.5}
    
    MDLabel:
        text: f"Analysis Error: {root.error_message}"
        theme_text_color: "Error"
        font_style: "Headline"
        role: "small"
        halign: "center"
        text_size: dp(400), None
    
    MDLabel:
        text: "Please try again or contact support if the issue persists"
        theme_text_color: "Secondary"
        font_style: "Body"
        role: "medium"
        halign: "center"
    
    MDButton:
        text: "Retry Analysis"
        style: "filled"
        size_hint: None, None
        size: dp(140), dp(40)
        pos_hint: {'center_x': 0.5}
        theme_bg_color: "Custom"
        md_bg_color: app.theme_cls.primaryColor

# Basic Statistics Display Component
<BasicStatisticsDisplay@MDCard>:
    stats_data: {}
    
    orientation: 'vertical'
    size_hint_y: None
    height: dp(200)
    elevation: 1
    md_bg_color: 0.99, 0.99, 0.99, 1
    radius: [8, 8, 8, 8]
    padding: [dp(12), dp(12), dp(12), dp(12)]
    spacing: dp(8)
    
    MDLabel:
        text: "Basic Statistics Summary"
        theme_text_color: "Primary"
        font_style: "Body"
        role: "medium"
        bold: True
        size_hint_y: None
        height: dp(24)
    
    GridLayout:
        cols: 2
        spacing: dp(8)
        size_hint_y: None
        height: dp(160)
        
        MDLabel:
            text: f"Total Variables: {root.stats_data.get('total_variables', 'N/A')}"
            theme_text_color: "Secondary"
            font_style: "Body"
            role: "small"
        
        MDLabel:
            text: f"Total Observations: {root.stats_data.get('total_observations', 'N/A')}"
            theme_text_color: "Secondary"
            font_style: "Body"
            role: "small"

# Data Quality Display Component
<DataQualityDisplay@MDCard>:
    quality_data: {}
    
    orientation: 'vertical'
    size_hint_y: None
    height: dp(200)
    elevation: 1
    md_bg_color: 0.99, 0.99, 0.99, 1
    radius: [8, 8, 8, 8]
    padding: [dp(12), dp(12), dp(12), dp(12)]
    spacing: dp(8)
    
    MDLabel:
        text: "Data Quality Assessment"
        theme_text_color: "Primary"
        font_style: "Body"
        role: "medium"
        bold: True
        size_hint_y: None
        height: dp(24)
    
    GridLayout:
        cols: 2
        spacing: dp(8)
        size_hint_y: None
        height: dp(160)
        
        MDLabel:
            text: f"Overall Score: {root.quality_data.get('overall_score', 0)}%"
            theme_text_color: "Primary"
            font_style: "Body"
            role: "medium"
            bold: True
        
        MDLabel:
            text: f"Completeness: {root.quality_data.get('completeness_score', 0)}%"
            theme_text_color: "Secondary"
            font_style: "Body"
            role: "small"
        
        MDLabel:
            text: f"Consistency: {root.quality_data.get('consistency_score', 0)}%"
            theme_text_color: "Secondary"
            font_style: "Body"
            role: "small"
        
        MDLabel:
            text: f"Validity: {root.quality_data.get('validity_score', 0)}%"
            theme_text_color: "Secondary"
            font_style: "Body"
            role: "small"

# Distribution Results Display Component
<DistributionResultsDisplay@MDCard>:
    distribution_data: {}
    
    orientation: 'vertical'
    size_hint_y: None
    height: dp(300)
    elevation: 1
    md_bg_color: 0.99, 0.99, 0.99, 1
    radius: [8, 8, 8, 8]
    padding: [dp(12), dp(12), dp(12), dp(12)]
    spacing: dp(8)
    
    MDLabel:
        text: "Distribution Analysis Results"
        theme_text_color: "Primary"
        font_style: "Body"
        role: "medium"
        bold: True
        size_hint_y: None
        height: dp(24)
    
    MDScrollView:
        do_scroll_x: False
        do_scroll_y: True
        bar_width: dp(8)
        
        MDBoxLayout:
            orientation: 'vertical'
            spacing: dp(8)
            size_hint_y: None
            height: self.minimum_height
            
            MDLabel:
                text: f"Variables Analyzed: {root.distribution_data.get('variables_analyzed', 'N/A')}"
                theme_text_color: "Secondary"
                font_style: "Body"
                role: "small"
                size_hint_y: None
                height: dp(20)
            
            MDLabel:
                text: f"Analysis Methods: {root.distribution_data.get('analysis_methods', 'Normality tests, skewness, kurtosis')}"
                theme_text_color: "Secondary"
                font_style: "Body"
                role: "small"
                text_size: self.width, None
                size_hint_y: None
                height: dp(40)

# Categorical Results Display Component
<CategoricalResultsDisplay@MDCard>:
    categorical_data: {}
    
    orientation: 'vertical'
    size_hint_y: None
    height: dp(300)
    elevation: 1
    md_bg_color: 0.99, 0.99, 0.99, 1
    radius: [8, 8, 8, 8]
    padding: [dp(12), dp(12), dp(12), dp(12)]
    spacing: dp(8)
    
    MDLabel:
        text: "Categorical Analysis Results"
        theme_text_color: "Primary"
        font_style: "Body"
        role: "medium"
        bold: True
        size_hint_y: None
        height: dp(24)
    
    MDScrollView:
        do_scroll_x: False
        do_scroll_y: True
        bar_width: dp(8)
        
        MDBoxLayout:
            orientation: 'vertical'
            spacing: dp(8)
            size_hint_y: None
            height: self.minimum_height
            
            MDLabel:
                text: f"Variables Analyzed: {root.categorical_data.get('variables_analyzed', 'N/A')}"
                theme_text_color: "Secondary"
                font_style: "Body"
                role: "small"
                size_hint_y: None
                height: dp(20)
            
            MDLabel:
                text: f"Cross-tabs Computed: {root.categorical_data.get('cross_tabs_computed', 'N/A')}"
                theme_text_color: "Secondary"
                font_style: "Body"
                role: "small"
                size_hint_y: None
                height: dp(20)
            
            MDLabel:
                text: f"Analysis Methods: {root.categorical_data.get('analysis_methods', 'Frequency analysis, chi-square tests')}"
                theme_text_color: "Secondary"
                font_style: "Body"
                role: "small"
                text_size: self.width, None
                size_hint_y: None
                height: dp(40)

# ===== NEW ADVANCED ANALYTICS DIALOGS =====

# Advanced Analysis Menu Dialog
<AdvancedAnalysisDialog@MDDialog>:
    id: advanced_analysis_dialog
    
    MDDialogHeadlineText:
        text: "Advanced Analytics"
    
    MDDialogSupportingText:
        text: "Choose from advanced descriptive analysis methods"
    
    MDScrollView:
        size_hint_y: None
        height: dp(500)
        
        MDBoxLayout:
            orientation: 'vertical'
            spacing: dp(12)
            size_hint_y: None
            height: self.minimum_height
            padding: [dp(16), dp(16), dp(16), dp(16)]
            
            # Geospatial Analysis
            MDButton:
                text: "Geospatial Analysis"
                style: "outlined"
                size_hint_y: None
                height: dp(48)
                theme_outline_color: "Custom" 
                line_color: 0.8, 0.4, 0.6, 1
                on_release: root.show_geospatial_dialog()
            
            # Temporal Analysis
            MDButton:
                text: "Temporal Analysis"
                style: "outlined"
                size_hint_y: None
                height: dp(48)
                theme_outline_color: "Custom"
                line_color: 0.6, 0.8, 0.4, 1
                on_release: root.show_temporal_dialog()
            
            # Cross-Tabulation
            MDButton:
                text: "Cross-Tabulation Analysis"
                style: "outlined"
                size_hint_y: None
                height: dp(48)
                theme_outline_color: "Custom"
                line_color: 0.4, 0.6, 0.8, 1
                on_release: root.show_cross_tabulation_dialog()
            
            # Weighted Statistics
            MDButton:
                text: "Weighted Statistics"
                style: "outlined"
                size_hint_y: None
                height: dp(48)
                theme_outline_color: "Custom"
                line_color: 0.8, 0.6, 0.4, 1
                on_release: root.show_weighted_stats_dialog()
            
            # Normality Tests
            MDButton:
                text: "Normality Tests"
                style: "outlined"
                size_hint_y: None
                height: dp(48)
                theme_outline_color: "Custom"
                line_color: 0.8, 0.6, 0.4, 1
                on_release: root.run_normality_tests()
            
            # Distribution Fitting
            MDButton:
                text: "Distribution Fitting"
                style: "outlined"
                size_hint_y: None
                height: dp(48)
                theme_outline_color: "Custom"
                line_color: 0.4, 0.8, 0.8, 1
                on_release: root.run_distribution_fitting()
            
            # Diversity Metrics
            MDButton:
                text: "Diversity Metrics"
                style: "outlined"
                size_hint_y: None
                height: dp(48)
                theme_outline_color: "Custom"
                line_color: 0.6, 0.4, 0.8, 1
                on_release: root.run_diversity_metrics()
            
            # Categorical Associations
            MDButton:
                text: "Categorical Associations"
                style: "outlined"
                size_hint_y: None
                height: dp(48)
                theme_outline_color: "Custom"
                line_color: 0.4, 0.8, 0.6, 1
                on_release: root.run_categorical_associations()
            
            # Missing Patterns
            MDButton:
                text: "Missing Data Patterns"
                style: "outlined"
                size_hint_y: None
                height: dp(48)
                theme_outline_color: "Custom"
                line_color: 0.6, 0.6, 0.6, 1
                on_release: root.run_missing_patterns_analysis()
            
            # Export Options
            MDButton:
                text: "Export Options"
                style: "text"
                size_hint_y: None
                height: dp(48)
                theme_text_color: "Custom"
                text_color: app.theme_cls.primaryColor
                on_release: root.show_export_options_dialog()
    
    MDDialogButtonContainer:
        MDButton:
            text: "Close"
            style: "text"
            on_release: advanced_analysis_dialog.dismiss()

# Geospatial Analysis Dialog
<GeospatialAnalysisDialog@MDDialog>:
    id: geospatial_dialog
    
    MDDialogHeadlineText:
        text: "Geospatial Analysis Parameters"
    
    MDDialogSupportingText:
        text: "Configure parameters for spatial analysis"
    
    MDBoxLayout:
        orientation: 'vertical'
        spacing: dp(16)
        size_hint_y: None
        height: dp(300)
        padding: [dp(16), dp(16), dp(16), dp(16)]
        
        MDTextField:
            id: lat_column_field
            hint_text: "Latitude Column Name"
            helper_text: "Column containing latitude coordinates"
            helper_text_mode: "on_focus"
        
        MDTextField:
            id: lon_column_field
            hint_text: "Longitude Column Name"
            helper_text: "Column containing longitude coordinates"
            helper_text_mode: "on_focus"
        
        MDTextField:
            id: value_column_field
            hint_text: "Value Column (Optional)"
            helper_text: "Column for weighted spatial analysis"
            helper_text_mode: "on_focus"
        
        MDTextField:
            id: max_distance_field
            hint_text: "Max Distance (km)"
            text: "10.0"
            helper_text: "Maximum distance for spatial autocorrelation"
            helper_text_mode: "on_focus"
        
        MDTextField:
            id: n_clusters_field
            hint_text: "Number of Clusters"
            text: "5"
            helper_text: "Number of location clusters to create"
            helper_text_mode: "on_focus"
    
    MDDialogButtonContainer:
        MDButton:
            text: "Cancel"
            style: "text"
            on_release: geospatial_dialog.dismiss()
        
        MDButton:
            text: "Run Analysis"
            style: "filled"
            theme_bg_color: "Custom"
            md_bg_color: app.theme_cls.primaryColor
            on_release: root.run_geospatial_analysis(lat_column_field.text, lon_column_field.text, value_column_field.text if value_column_field.text else None, float(max_distance_field.text) if max_distance_field.text else 10.0, int(n_clusters_field.text) if n_clusters_field.text else 5)

# Temporal Analysis Dialog
<TemporalAnalysisDialog@MDDialog>:
    id: temporal_dialog
    
    MDDialogHeadlineText:
        text: "Temporal Analysis Parameters"
    
    MDDialogSupportingText:
        text: "Configure parameters for time series analysis"
    
    MDBoxLayout:
        orientation: 'vertical'
        spacing: dp(16)
        size_hint_y: None
        height: dp(250)
        padding: [dp(16), dp(16), dp(16), dp(16)]
        
        MDTextField:
            id: date_column_field
            hint_text: "Date/Time Column Name"
            helper_text: "Column containing date/time data"
            helper_text_mode: "on_focus"
        
        MDTextField:
            id: value_columns_field
            hint_text: "Value Columns (comma-separated)"
            helper_text: "Columns to analyze over time (leave empty for all numeric)"
            helper_text_mode: "on_focus"
        
        MDCheckbox:
            id: detect_seasonal_checkbox
            active: True
            size_hint_x: None
            width: dp(48)
        
        MDLabel:
            text: "Detect Seasonality"
            theme_text_color: "Primary"
            size_hint_x: None
            width: dp(150)
        
        MDTextField:
            id: seasonal_period_field
            hint_text: "Seasonal Period (Optional)"
            helper_text: "Period for seasonality detection (auto-detect if empty)"
            helper_text_mode: "on_focus"
    
    MDDialogButtonContainer:
        MDButton:
            text: "Cancel"
            style: "text"
            on_release: temporal_dialog.dismiss()
        
        MDButton:
            text: "Run Analysis"
            style: "filled"
            theme_bg_color: "Custom"
            md_bg_color: app.theme_cls.primaryColor
            on_release: root.run_temporal_analysis(date_column_field.text, value_columns_field.text.split(',') if value_columns_field.text else None, detect_seasonal_checkbox.active, int(seasonal_period_field.text) if seasonal_period_field.text else None)

# Cross-Tabulation Dialog
<CrossTabulationDialog@MDDialog>:
    id: cross_tabulation_dialog
    
    MDDialogHeadlineText:
        text: "Cross-Tabulation Parameters"
    
    MDDialogSupportingText:
        text: "Configure variables for cross-tabulation analysis"
    
    MDBoxLayout:
        orientation: 'vertical'
        spacing: dp(16)
        size_hint_y: None
        height: dp(200)
        padding: [dp(16), dp(16), dp(16), dp(16)]
        
        MDTextField:
            id: var1_field
            hint_text: "First Variable (Rows)"
            helper_text: "Categorical variable for table rows"
            helper_text_mode: "on_focus"
        
        MDTextField:
            id: var2_field
            hint_text: "Second Variable (Columns)"
            helper_text: "Categorical variable for table columns"
            helper_text_mode: "on_focus"
        
        MDTextField:
            id: normalize_field
            hint_text: "Normalization (Optional)"
            helper_text: "Options: index, columns, all (leave empty for none)"
            helper_text_mode: "on_focus"
    
    MDDialogButtonContainer:
        MDButton:
            text: "Cancel"
            style: "text"
            on_release: cross_tabulation_dialog.dismiss()
        
        MDButton:
            text: "Run Analysis"
            style: "filled"
            theme_bg_color: "Custom"
            md_bg_color: app.theme_cls.primaryColor
            on_release: root.run_cross_tabulation(var1_field.text, var2_field.text, normalize_field.text if normalize_field.text else None)

# Weighted Statistics Dialog
<WeightedStatsDialog@MDDialog>:
    id: weighted_stats_dialog
    
    MDDialogHeadlineText:
        text: "Weighted Statistics Parameters"
    
    MDDialogSupportingText:
        text: "Configure columns for weighted statistical analysis"
    
    MDBoxLayout:
        orientation: 'vertical'
        spacing: dp(16)
        size_hint_y: None
        height: dp(150)
        padding: [dp(16), dp(16), dp(16), dp(16)]
        
        MDTextField:
            id: value_column_field
            hint_text: "Value Column"
            helper_text: "Column containing values to analyze"
            helper_text_mode: "on_focus"
        
        MDTextField:
            id: weight_column_field
            hint_text: "Weight Column"
            helper_text: "Column containing weights for each observation"
            helper_text_mode: "on_focus"
    
    MDDialogButtonContainer:
        MDButton:
            text: "Cancel"
            style: "text"
            on_release: weighted_stats_dialog.dismiss()
        
        MDButton:
            text: "Run Analysis"
            style: "filled"
            theme_bg_color: "Custom"
            md_bg_color: app.theme_cls.primaryColor
            on_release: root.run_weighted_statistics(value_column_field.text, weight_column_field.text)

# Export Options Dialog
<ExportOptionsDialog@MDDialog>:
    id: export_options_dialog
    
    MDDialogHeadlineText:
        text: "Export Report Options"
    
    MDDialogSupportingText:
        text: "Choose export format and analysis type"
    
    MDBoxLayout:
        orientation: 'vertical'
        spacing: dp(16)
        size_hint_y: None
        height: dp(250)
        padding: [dp(16), dp(16), dp(16), dp(16)]
        
        MDLabel:
            text: "Export Format:"
            theme_text_color: "Primary"
            font_style: "Body"
            role: "medium"
            size_hint_y: None
            height: dp(24)
        
        MDBoxLayout:
            orientation: 'horizontal'
            spacing: dp(8)
            size_hint_y: None
            height: dp(48)
            
            MDButton:
                text: "JSON"
                style: "outlined"
                size_hint_x: 0.33
                theme_outline_color: "Custom"
                line_color: app.theme_cls.primaryColor
                on_release: root.export_analysis_report('json')
            
            MDButton:
                text: "HTML"
                style: "outlined"
                size_hint_x: 0.33
                theme_outline_color: "Custom"
                line_color: app.theme_cls.primaryColor
                on_release: root.export_analysis_report('html')
            
            MDButton:
                text: "Markdown"
                style: "outlined"
                size_hint_x: 0.34
                theme_outline_color: "Custom"
                line_color: app.theme_cls.primaryColor
                on_release: root.export_analysis_report('markdown')
        
        MDLabel:
            text: "Analysis Type:"
            theme_text_color: "Primary"
            font_style: "Body"
            role: "medium"
            size_hint_y: None
            height: dp(24)
        
        MDBoxLayout:
            orientation: 'horizontal'
            spacing: dp(8)
            size_hint_y: None
            height: dp(48)
            
            MDButton:
                text: "Comprehensive"
                style: "filled"
                size_hint_x: 0.5
                theme_bg_color: "Custom"
                md_bg_color: app.theme_cls.primaryColor
                on_release: root.export_analysis_report('json', 'comprehensive')
            
            MDButton:
                text: "Executive"
                style: "outlined"
                size_hint_x: 0.5
                theme_outline_color: "Custom"
                line_color: app.theme_cls.primaryColor
                on_release: root.export_analysis_report('json', 'executive')
    
    MDDialogButtonContainer:
        MDButton:
            text: "Close"
            style: "text"
            on_release: export_options_dialog.dismiss() 