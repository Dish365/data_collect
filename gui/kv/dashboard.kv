#:import dp kivy.metrics.dp
#:import app kivy.app.App
#:import Window kivy.core.window.Window

<DashboardScreen>:
    name: "dashboard"
    md_bg_color: app.theme_cls.backgroundColor

    MDBoxLayout:
        orientation: 'vertical'
        size_hint: 1, 1

        # Modern Top Bar with Material Design 3 styling
        TopBar:
            id: top_bar
            size_hint_y: None
            height: dp(64)

        # Main content with enhanced Material Design 3 layout
        RelativeLayout:
            size_hint: 1, 1
            
            # Main scrollable content with improved styling
            MDScrollView:
                id: main_scroll_view
                size_hint: 1, 1
                do_scroll_x: False
                bar_width: dp(6)
                # Using default bar colors for KivyMD 2.0.1 compatibility
                effect_cls: "ScrollEffect"
                smooth_scroll_end: 10
                scroll_timeout: 55
                
                MDBoxLayout:
                    id: content_layout
                    orientation: 'vertical'
                    padding: dp(32), dp(20), dp(32), dp(28)
                    spacing: dp(32)
                    adaptive_height: True
                    size_hint_y: None
                    height: self.minimum_height
                    md_bg_color: app.theme_cls.backgroundColor

                    # Page title with Material Design 3 typography
                    MDLabel:
                        text: "Research Dashboard"
                        font_style: "Display"
                        role: "small"
                        theme_text_color: "Primary"
                        size_hint_y: None
                        height: self.texture_size[1] + dp(16)
                        text_size: self.width, None
                        halign: "left"

                    # Overview section
                    MDLabel:
                        text: "Overview"
                        font_style: "Headline"
                        role: "small"
                        text_size: self.width, None
                        theme_text_color: "Primary"
                        size_hint_y: None
                        height: self.texture_size[1] + dp(12)
                        halign: "left"

                    # Stats cards container with enhanced responsive grid
                    MDCard:
                        orientation: 'vertical'
                        adaptive_height: True
                        size_hint_y: None
                        height: self.minimum_height
                        elevation: 0
                        style: "outlined"
                        md_bg_color: app.theme_cls.surfaceContainerColor
                        padding: dp(20)
                        radius: [dp(16)]
                        
                        MDBoxLayout:
                            id: stats_container
                            orientation: 'vertical'
                            adaptive_height: True
                            size_hint_y: None
                            height: self.minimum_height
                            spacing: dp(20)
                            
                            MDGridLayout:
                                id: stats_grid
                                adaptive_height: True
                                size_hint_y: None
                                height: self.minimum_height
                                spacing: dp(20)
                                cols: 1  # Updated dynamically by Python

                                StatCard:
                                    id: total_responses_card
                                    title: "Total Respondents"
                                    value: "Loading..."
                                    icon: "account-group"
                                    size_hint_y: None
                                    height: dp(140)
                                    elevation: 2
                                    style: "elevated"
                                    on_press: root.navigate_to("responses")

                                StatCard:
                                    id: active_projects_card
                                    title: "Active Projects"
                                    value: "Loading..."
                                    icon: "folder-multiple"
                                    size_hint_y: None
                                    height: dp(140)
                                    elevation: 2
                                    style: "elevated"
                                    on_press: root.navigate_to("projects")

                                StatCard:
                                    id: pending_sync_card
                                    title: "Pending Sync"
                                    value: "Loading..."
                                    icon: "sync"
                                    size_hint_y: None
                                    height: dp(140)
                                    elevation: 2
                                    style: "elevated"
                                    on_press: root.navigate_to("sync")

                                StatCard:
                                    id: team_members_card
                                    title: "Team Members"
                                    value: "Loading..."
                                    note: "Click to manage"
                                    icon: "account-multiple"
                                    size_hint_y: None
                                    height: dp(140)
                                    elevation: 2
                                    style: "elevated"
                                    on_press: root.open_team_management()

                    # Quick Actions section
                    MDLabel:
                        text: "Quick Actions"
                        font_style: "Headline"
                        role: "small"
                        text_size: self.width, None
                        theme_text_color: "Primary"
                        size_hint_y: None
                        height: self.texture_size[1] + dp(12)
                        halign: "left"

                    # Action buttons with enhanced Material Design 3 styling
                    MDCard:
                        orientation: 'vertical'
                        adaptive_height: True
                        size_hint_y: None
                        height: self.minimum_height
                        elevation: 0
                        style: "outlined"
                        md_bg_color: app.theme_cls.surfaceContainerColor
                        padding: dp(20)
                        radius: [dp(16)]
                        
                        MDBoxLayout:
                            id: actions_container
                            orientation: 'vertical'
                            adaptive_height: True
                            size_hint_y: None
                            height: self.minimum_height
                            spacing: dp(20)
                            
                            MDGridLayout:
                                id: actions_grid
                                adaptive_height: True
                                size_hint_y: None
                                height: self.minimum_height
                                spacing: dp(16)
                                cols: 2  # Updated dynamically by Python
                                row_default_height: dp(64)
                                row_force_default: True
                            
                                MDButton:
                                    style: "elevated"
                                    size_hint: 1, None
                                    height: dp(64)
                                    elevation: 2
                                    on_release: root.navigate_to("projects")
                                    
                                    MDButtonIcon:
                                        icon: "folder-multiple"
                                        theme_icon_color: "Custom"
                                        icon_color: app.theme_cls.primaryColor
                                    
                                    MDButtonText:
                                        text: "Manage Projects"
                                        font_style: "Label"
                                        role: "large"

                                MDButton:
                                    style: "elevated"
                                    size_hint: 1, None
                                    height: dp(64)
                                    elevation: 2
                                    on_release: root.navigate_to("data_collection")
                                    
                                    MDButtonIcon:
                                        icon: "database-plus"
                                        theme_icon_color: "Custom"
                                        icon_color: app.theme_cls.primaryColor
                                    
                                    MDButtonText:
                                        text: "Collect Data"
                                        font_style: "Label"
                                        role: "large"

                                MDButton:
                                    style: "elevated"
                                    size_hint: 1, None
                                    height: dp(64)
                                    elevation: 2
                                    on_release: root.navigate_to("analytics")
                                    
                                    MDButtonIcon:
                                        icon: "chart-line"
                                        theme_icon_color: "Custom"
                                        icon_color: app.theme_cls.primaryColor
                                    
                                    MDButtonText:
                                        text: "View Analytics"
                                        font_style: "Label"
                                        role: "large"

                                MDButton:
                                    style: "elevated"
                                    size_hint: 1, None
                                    height: dp(64)
                                    elevation: 2
                                    on_release: root.navigate_to("data_exploration")
                                    
                                    MDButtonIcon:
                                        icon: "compass"
                                        theme_icon_color: "Custom"
                                        icon_color: app.theme_cls.primaryColor
                                    
                                    MDButtonText:
                                        text: "Explore Data"
                                        font_style: "Label"
                                        role: "large"

                                MDButton:
                                    style: "elevated"
                                    size_hint: 1, None
                                    height: dp(64)
                                    elevation: 2
                                    on_release: root.navigate_to("qualitative_analytics")
                                    
                                    MDButtonIcon:
                                        icon: "text-search"
                                        theme_icon_color: "Custom"
                                        icon_color: app.theme_cls.primaryColor
                                    
                                    MDButtonText:
                                        text: "Qualitative Analysis"
                                        font_style: "Label"
                                        role: "large"

                                MDButton:
                                    style: "elevated"
                                    size_hint: 1, None
                                    height: dp(64)
                                    elevation: 2
                                    on_release: root.navigate_to("form_builder")
                                    
                                    MDButtonIcon:
                                        icon: "form-select"
                                        theme_icon_color: "Custom"
                                        icon_color: app.theme_cls.primaryColor
                                    
                                    MDButtonText:
                                        text: "Build Forms"
                                        font_style: "Label"
                                        role: "large"

                                MDButton:
                                    style: "tonal"
                                    size_hint: 1, None
                                    height: dp(64)
                                    on_release: root.open_team_management()
                                    
                                    MDButtonIcon:
                                        icon: "account-multiple"
                                        theme_icon_color: "Custom"
                                        icon_color: app.theme_cls.primaryColor
                                    
                                    MDButtonText:
                                        text: "Team Members"
                                        font_style: "Label"
                                        role: "large"

                                MDButton:
                                    style: "tonal"
                                    size_hint: 1, None
                                    height: dp(64)
                                    on_release: root.navigate_to("sync")
                                    
                                    MDButtonIcon:
                                        icon: "sync"
                                        theme_icon_color: "Custom"
                                        icon_color: app.theme_cls.primaryColor
                                
                                MDButtonText:
                                    text: "Sync Status"
                                    font_style: "Label"
                                    role: "large"

                    # Recent Activity section
                    MDLabel:
                        text: "Recent Activity"
                        font_style: "Headline"
                        role: "small"
                        text_size: self.width, None
                        theme_text_color: "Primary"
                        size_hint_y: None
                        height: self.texture_size[1] + dp(12)
                        halign: "left"

                    # Activity feed with Material Design 3 card
                    MDCard:
                        style: "elevated"
                        orientation: "vertical"
                        adaptive_height: True
                        size_hint_y: None
                        height: self.minimum_height
                        padding: dp(16)
                        spacing: dp(8)

                        MDBoxLayout:
                            id: activity_feed_layout
                            orientation: "vertical"
                            spacing: dp(8)
                            adaptive_height: True
                            size_hint_y: None
                            height: self.minimum_height

            # Modern loading overlay with Material Design 3
            MDCard:
                id: loading_card
                style: "elevated"
                size_hint: None, None
                size: dp(120), dp(120)
                pos_hint: {'center_x': .5, 'center_y': .5}
                opacity: 0
                
                MDBoxLayout:
                    orientation: "vertical"
                    spacing: dp(16)
                    pos_hint: {'center_x': .5, 'center_y': .5}
                    adaptive_height: True
                    
                    MDCircularProgressIndicator:
                        id: spinner
                        size_hint: None, None
                        size: dp(48), dp(48)
                        pos_hint: {'center_x': .5}
                        active: False
                    
                    MDLabel:
                        text: "Loading..."
                        font_style: "Body"
                        role: "medium"
                        theme_text_color: "Secondary"
                        halign: "center"
                        size_hint_y: None
                        height: self.texture_size[1]