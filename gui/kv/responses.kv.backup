#:import dp kivy.metrics.dp
#:import MDBoxLayout kivymd.uix.boxlayout.MDBoxLayout
#:import MDCard kivymd.uix.card.MDCard
#:import MDButton kivymd.uix.button.MDButton
#:import MDButtonText kivymd.uix.button.MDButtonText
#:import MDButtonIcon kivymd.uix.button.MDButtonIcon
#:import MDTextField kivymd.uix.textfield.MDTextField
#:import MDLabel kivymd.uix.label.MDLabel
#:import MDIconButton kivymd.uix.button.MDIconButton
#:import MDCheckbox kivymd.uix.selectioncontrol.MDCheckbox
#:import ScrollView kivy.uix.scrollview.ScrollView
#:import MDCircularProgressIndicator kivymd.uix.progressindicator.MDCircularProgressIndicator
#:import MDDialog kivymd.uix.dialog.MDDialog

<ResponsesScreen>:
    name: "responses"

    MDBoxLayout:
        orientation: "vertical"
        

        # Responsive TopBar - Larger for tablets
        TopBar:
            id: top_bar
            size_hint_y: None
            height: dp(64) if root.tablet_view or root.desktop_view else dp(56)

        # Main content layout - Responsive using MDResponsiveLayout
        MDBoxLayout:
            id: main_content_layout
            orientation: "vertical" if root.mobile_view else "horizontal"
            spacing: dp(16)  # Increased spacing
            padding: dp(24)  # Increased padding for tablets
            # Left Panel / Top Panel (Master View)
            MDBoxLayout:
                id: master_panel
                orientation: "vertical"
                size_hint_x: 0.6 if root.tablet_view or root.desktop_view else 1
                spacing: dp(12)

                # Header section with controls - Enhanced for tablets
                MDCard:
                    padding: dp(20)  # Increased padding for tablets
                    spacing: dp(12)  # Increased spacing
                    size_hint_y: None
                    height: dp(120)  # Reduced height without summary
                    elevation: 2
                    
                    MDBoxLayout:
                        orientation: "vertical"
                        spacing: dp(12)  # Increased spacing
                        
                        # Controls Row - Tablet optimized with larger touch targets
                        MDBoxLayout:
                            orientation: "horizontal"
                            spacing: dp(16)  # Increased spacing
                            size_hint_y: None
                            height: dp(56)  # Increased height for tablets

                            # Left Section: Back arrow + Title
                            MDBoxLayout:
                                orientation: "horizontal"
                                spacing: dp(12)  # Increased spacing
                                size_hint_x: 0.4
                                pos_hint: {"center_y": 0.5}

                                MDIconButton:
                                    icon: "arrow-left"
                                    size_hint_x: None
                                    width: dp(56)  # Larger touch target
                                    user_font_size: "28sp"  # Larger icon
                                    on_release: root.go_back_to_dashboard()
                                    theme_icon_color: "Custom"
                                    icon_color: 0, 0, 0, 1
                                    pos_hint: {"center_y": 0.5}

                                MDLabel:
                                    text: "Survey Responses"
                                    font_style: "H6"
                                    font_size: "22sp"  # Larger font for tablets
                                    pos_hint: {"center_y": 0.5}
                                    size_hint_x: None
                                    width: dp(200)  # Slightly wider

                            # Right Section: Search bar + Refresh button - Enhanced for tablets
                            MDBoxLayout:
                                orientation: "horizontal"
                                spacing: dp(12)  # Increased spacing
                                size_hint_x: 0.6
                                pos_hint: {"center_y": 0.5}

                                MDTextField:
                                    id: search_field
                                    hint_text: "Search by ID, name, or project..."
                                    size_hint_x: 0.8
                                    height: dp(52)  # Tablet-friendly height
                                    font_size: "16sp"  # Larger font
                                    pos_hint: {"center_y": 0.5}
                                    mode: "rectangle"
                                    on_text: root.search_respondents(self.text)

                                MDIconButton:
                                    icon: "refresh"
                                    size_hint_x: None
                                    width: dp(56)  # Larger touch target
                                    user_font_size: "28sp"  # Larger icon
                                    on_release: root.refresh_data()
                                    pos_hint: {"center_y": 0.5}

                        # Bulk Actions Toolbar (new for tablets)
                        MDBoxLayout:
                            id: bulk_actions_toolbar
                            orientation: "horizontal"
                            spacing: dp(12)
                            size_hint_y: None
                            height: dp(52)  # Tablet-friendly height
                            
                            MDButton:
                                style: "elevated"
                                size_hint_x: None
                                width: dp(140)
                                height: dp(44)  # Tablet touch target
                                disabled: True
                                
                                MDButtonText:
                                    text: "Export Selected"
                                    font_size: "16sp"
                                
                            MDButton:
                                style: "elevated"
                                size_hint_x: None
                                width: dp(140)
                                height: dp(44)
                                theme_bg_color: "Error"
                                disabled: True
                                
                                MDButtonText:
                                    text: "Delete Selected"
                                    font_size: "16sp"
                                
                            Widget:  # Spacer
                                size_hint_x: 1
                                
                            MDLabel:
                                id: selection_count_label
                                text: "0 selected"
                                font_size: "16sp"
                                size_hint_x: None
                                width: dp(100)

                # Table Header - Enhanced for tablets
                MDCard:
                    padding: dp(16)  # Increased padding
                    size_hint_y: None
                    height: dp(60)  # Increased height for tablets
                    elevation: 1
                    md_bg_color: app.theme_cls.primary_color
                    
                    MDBoxLayout:
                        orientation: "horizontal"
                        spacing: dp(8)  # Increased spacing
                        
                        # Selection checkbox for "select all"
                        MDCheckbox:
                            id: select_all_checkbox
                            size_hint_x: None
                            width: dp(48)  # Tablet touch target
                            pos_hint: {"center_y": 0.5}
                            on_active: root.on_select_all(self.active)
                        
                        MDLabel:
                            text: "Respondent ID"
                            size_hint_x: 0.18
                            font_style: "Subtitle2"
                            font_size: "16sp"  # Larger font for tablets
                            halign: "left"
                            theme_text_color: "Primary"
                            
                        MDLabel:
                            text: "Name"
                            size_hint_x: 0.18
                            font_style: "Subtitle2"
                            font_size: "16sp"
                            halign: "left"
                            theme_text_color: "Primary"
                            
                        MDLabel:
                            text: "Project"
                            size_hint_x: 0.25
                            font_style: "Subtitle2"
                            font_size: "16sp"
                            halign: "left"
                            theme_text_color: "Primary"
                            
                        MDLabel:
                            text: "Actions"
                            size_hint_x: 0.25
                            font_style: "Subtitle2"
                            font_size: "16sp"
                            halign: "center"
                            theme_text_color: "Primary"

                # Scrollable content area - Enhanced for tablets
                ScrollView:
                    MDBoxLayout:
                        id: responses_grid
                        orientation: "vertical"
                        spacing: dp(4)  # Increased spacing between rows
                        padding: [0, dp(12), 0, dp(12)]  # Increased padding
                        adaptive_height: True
                        
            # Right Panel (Detail View) - Responsive visibility
            MDCard:
                id: detail_panel
                size_hint_x: 0.4 if root.tablet_view or root.desktop_view else 0
                opacity: 1 if root.tablet_view or root.desktop_view else 0
                disabled: not (root.tablet_view or root.desktop_view)
                elevation: 2
                padding: dp(20)
                orientation: "vertical"
                spacing: dp(16)
                
                MDLabel:
                    text: "Response Details"
                    font_style: "H6"
                    font_size: "20sp"
                    size_hint_y: None
                    height: dp(40)
                    
                ScrollView:
                    id: detail_scroll
                    
                    MDBoxLayout:
                        id: detail_content
                        orientation: "vertical"
                        spacing: dp(12)
                        adaptive_height: True
                        padding: dp(16)
                        
                        MDLabel:
                            text: "Select a respondent to view their responses"
                            halign: "center"
                            font_size: "16sp"
                            theme_text_color: "Secondary"

        # Loading spinner - Larger for tablets
        MDCircularProgressIndicator:
            id: spinner
            size_hint: None, None
            size: dp(56), dp(56)  # Larger spinner for tablets
            pos_hint: {'center_x': .5, 'center_y': .5}
            active: False

# Modern Response Item Component
<ResponseItem>:
    orientation: "horizontal"
    padding: dp(12)  # Increased padding for tablets
    spacing: dp(8)  # Increased spacing
    size_hint_y: None
    height: dp(72)  # Increased height for tablets
    elevation: 1
    
    # Selection checkbox
    MDCheckbox:
        id: selection_checkbox
        size_hint_x: None
        width: dp(48)  # Tablet touch target
        pos_hint: {"center_y": 0.5}
        on_active: root.on_checkbox_active(self.active)
    
    # Respondent ID
    MDLabel:
        id: respondent_id_label
        size_hint_x: 0.18
        font_style: "Body2"
        font_size: "16sp"  # Larger font for tablets
        halign: "left"
    
    # Display Name
    MDLabel:
        id: name_label
        size_hint_x: 0.18
        font_style: "Body2"
        font_size: "16sp"  # Larger font for tablets
        halign: "left"
    
    # Project Name
    MDLabel:
        id: project_label
        size_hint_x: 0.25
        font_style: "Body2"
        font_size: "16sp"  # Larger font for tablets
        halign: "left"
    
    # Actions (View, Edit, Delete) - Tablet optimized
    MDBoxLayout:
        id: actions_layout
        orientation: "horizontal"
        size_hint_x: 0.25
        spacing: dp(4)  # Increased spacing
        
        MDButton:
            style: "text"
            size_hint_x: None
            width: dp(50)
            height: dp(36)
            on_release: root.view_responses(None)
            
            MDButtonText:
                text: "View"
                theme_text_color: "Custom"
                text_color: 0.2, 0.6, 1, 1
                font_size: "12sp"
        
        MDButton:
            style: "text"
            size_hint_x: None
            width: dp(50)
            height: dp(36)
            on_release: root.edit_respondent(None)
            
            MDButtonText:
                text: "Edit"
                theme_text_color: "Custom"
                text_color: 1, 0.6, 0.2, 1
                font_size: "12sp"
        
        MDButton:
            style: "text"
            size_hint_x: None
            width: dp(50)
            height: dp(36)
            on_release: root.delete_respondent(None)
            
            MDButtonText:
                text: "Delete"
                theme_text_color: "Custom"
                text_color: 1, 0.2, 0.2, 1
                font_size: "12sp"

# Modern Response Detail Dialog Component
<ResponseDetailDialog>:
    orientation: "vertical"
    spacing: dp(10)
    size_hint_y: None
    height: dp(400)
    
    # Respondent info header
    MDLabel:
        id: header_label
        font_style: "H6"
        size_hint_y: None
        height: dp(40)
    
    # Project info
    MDLabel:
        id: project_info_label
        font_style: "Subtitle1"
        size_hint_y: None
        height: dp(30)
    
    # Responses list
    ScrollView:
        MDBoxLayout:
            id: responses_layout
            orientation: "vertical"
            spacing: dp(8)
            adaptive_height: True
            padding: dp(10)

# Modern Response Card Component
<ResponseCard>:
    orientation: "vertical"
    padding: dp(10)
    spacing: dp(5)
    size_hint_y: None
    height: dp(80)
    elevation: 2
    
    MDLabel:
        id: question_label
        font_style: "Subtitle2"
        size_hint_y: None
        height: dp(25)
    
    MDLabel:
        id: answer_label
        font_style: "Body1"
        size_hint_y: None
        height: dp(25)
    
    MDLabel:
        id: time_label
        font_style: "Caption"
        size_hint_y: None
        height: dp(20)

# Modern Action Button Component
<ActionButton>:
    size_hint_x: None
    width: dp(50)
    height: dp(36)
    theme_text_color: "Custom"
    font_size: "12sp"

# Load More Button Component
<LoadMoreButton>:
    style: "elevated"
    size_hint_y: None
    height: dp(40)
    on_release: root.load_more()
    
    MDButtonText:
        text: "Load More Respondents"
        font_size: "14sp"

# No Data Label Component
<NoDataLabel>:
    text: "No responses found. Start collecting data to see respondents here."
    halign: "center"
    font_style: "Subtitle1"
    font_size: "16sp"
    size_hint_y: None
    height: dp(60)

# Response Detail Content Component
<ResponseDetailContent>:
    orientation: "vertical"
    spacing: dp(10)
    size_hint_y: None
    height: dp(400)
    
    # Project info
    MDLabel:
        id: project_info_label
        font_style: "Subtitle1"
        size_hint_y: None
        height: dp(30)
    
    # Responses list
    ScrollView:
        MDBoxLayout:
            id: responses_layout
            orientation: "vertical"
            spacing: dp(8)
            adaptive_height: True
            padding: dp(10)

# No Responses Label Component
<NoResponsesLabel@MDLabel>:
    text: "No responses found for this respondent"
    halign: "center"
    size_hint_y: None
    height: dp(40)

# Edit Respondent Dialog Component
<EditRespondentDialog>:
    title: "Edit Respondent"
    type: "custom"
    size_hint: 0.8, None
    
    MDBoxLayout:
        orientation: "vertical"
        spacing: dp(10)
        size_hint_y: None
        height: dp(300)
        
        MDLabel:
            id: title_label
            text: "Edit Respondent"
            font_style: "H6"
            size_hint_y: None
            height: dp(40)
        
        MDTextField:
            id: name_field
            hint_text: "Name (optional)"
            size_hint_y: None
            height: dp(40)
        
        MDTextField:
            id: email_field
            hint_text: "Email (optional)"
            size_hint_y: None
            height: dp(40)
        
        MDTextField:
            id: phone_field
            hint_text: "Phone (optional)"
            size_hint_y: None
            height: dp(40)
        
        MDBoxLayout:
            orientation: "horizontal"
            size_hint_y: None
            height: dp(40)
            spacing: dp(10)
            
            MDCheckbox:
                id: anonymous_checkbox
                size_hint_x: None
                width: dp(30)
            
            MDLabel:
                text: "Anonymous respondent"
                size_hint_y: None
                height: dp(40)
    
    MDButton:
        style: "text"
        on_release: root.dismiss()
        
        MDButtonText:
            text: "CANCEL"
    
    MDButton:
        style: "elevated"
        on_release: root.save_changes()
        
        MDButtonText:
            text: "SAVE"

# Delete Confirm Dialog Component
<DeleteConfirmDialog>:
    title: "Confirm Delete"
    type: "custom"
    size_hint: 0.8, None
    
    MDLabel:
        id: confirm_text
        halign: "center"
        size_hint_y: None
        height: dp(100)
    
    MDButton:
        style: "text"
        on_release: root.dismiss()
        
        MDButtonText:
            text: "CANCEL"
    
    MDButton:
        style: "elevated"
        theme_bg_color: "Error"
        on_release: root.confirm_delete()
        
        MDButtonText:
            text: "DELETE" 