#:kivy 2.0
#:import dp kivy.metrics.dp
#:import app kivy.app.App
#:import MDCard kivymd.uix.card.MDCard
#:import MDBoxLayout kivymd.uix.boxlayout.MDBoxLayout
#:import MDScrollView kivymd.uix.scrollview.MDScrollView
#:import MDTextField kivymd.uix.textfield.MDTextField
#:import MDButton kivymd.uix.button.MDButton
#:import MDButtonText kivymd.uix.button.MDButtonText
#:import MDButtonIcon kivymd.uix.button.MDButtonIcon
#:import MDIconButton kivymd.uix.button.MDIconButton
#:import MDLabel kivymd.uix.label.MDLabel
#:import MDIcon kivymd.uix.label.MDIcon
#:import MDCheckbox kivymd.uix.selectioncontrol.MDCheckbox
#:import MDSlider kivymd.uix.slider.MDSlider
#:import MDCircularProgressIndicator kivymd.uix.progressindicator.MDCircularProgressIndicator

# Modern Form Builder Screen
<FormBuilderScreen>:
    FloatLayout:
        MDBoxLayout:
            orientation: 'vertical'
            size_hint: 1, 1
            md_bg_color: app.theme_cls.backgroundColor

            # Modern Top Bar
            TopBar:
                id: top_bar
                size_hint_y: None
                height: dp(56)

            # Project Selection Header
            MDCard:
                size_hint_y: None
                height: dp(72)
                elevation: 1
                md_bg_color: app.theme_cls.surfaceColor
                radius: [0, 0, 16, 16]
                
                MDBoxLayout:
                    orientation: 'horizontal'
                    padding: [dp(20), dp(16)]
                    spacing: dp(16)
                    
                    MDLabel:
                        text: "Project:"
                        font_style: "Title"
                        role: "large"
                        theme_text_color: "Primary"
                        size_hint_x: None
                        width: dp(80)
                    
                    MDButton:
                        id: project_selector
                        style: "outlined"
                        size_hint_x: 1
                        height: dp(40)
                        on_release: root.open_project_menu()
                        
                        MDButtonText:
                            text: 'Select Project'
                            font_size: '14sp'
                        
                        MDButtonIcon:
                            icon: "chevron-down"

            # Main Content Area
            MDBoxLayout:
                orientation: 'horizontal'
                spacing: dp(16)
                padding: [dp(20), dp(16), dp(20), dp(20)]
                
                # Left Sidebar - Question Types
                MDCard:
                    id: sidebar_card
                    orientation: 'vertical'
                    size_hint: (0.32, 1)
                    elevation: 2
                    md_bg_color: app.theme_cls.surfaceColor
                    radius: [20, 20, 20, 20]
                    
                    # Sidebar Header
                    MDBoxLayout:
                        orientation: 'vertical'
                        size_hint_y: None
                        height: dp(72)
                        padding: [dp(20), dp(16), dp(20), dp(12)]
                        
                        MDLabel:
                            text: "Question Types"
                            font_style: "Headline"
                            role: "small"
                            theme_text_color: "Primary"
                            bold: True
                        
                        MDLabel:
                            text: "Drag or click to add questions"
                            font_style: "Body"
                            role: "small"
                            theme_text_color: "Secondary"
                    
                    # Question Types Scroll
                    MDScrollView:
                        do_scroll_x: False
                        bar_width: dp(4)
                        
                        MDBoxLayout:
                            orientation: 'vertical'
                            padding: [dp(16), 0, dp(16), dp(16)]
                            spacing: dp(12)
                            size_hint_y: None
                            height: self.minimum_height
                            
                            # Text Questions
                            QuestionTypeSection:
                                section_title: "Text Input"
                                section_icon: "format-text"
                                section_color: 0.2, 0.6, 1.0, 1
                                
                                QuestionTypeButton:
                                    text: "Short Text"
                                    icon: "text-short"
                                    on_release: root.add_question('text_short')
                                
                                QuestionTypeButton:
                                    text: "Long Text"
                                    icon: "text-long"
                                    on_release: root.add_question('text_long')
                            
                            # Numeric Questions
                            QuestionTypeSection:
                                section_title: "Numbers"
                                section_icon: "numeric"
                                section_color: 1.0, 0.6, 0.2, 1
                                
                                QuestionTypeButton:
                                    text: "Integer"
                                    icon: "numeric"
                                    on_release: root.add_question('numeric_integer')
                                
                                QuestionTypeButton:
                                    text: "Decimal"
                                    icon: "numeric-9-plus"
                                    on_release: root.add_question('numeric_decimal')
                                
                                QuestionTypeButton:
                                    text: "Rating Scale"
                                    icon: "star"
                                    on_release: root.add_question('scale_rating')
                            
                            # Choice Questions
                            QuestionTypeSection:
                                section_title: "Choices"
                                section_icon: "checkbox-marked"
                                section_color: 0.8, 0.4, 0.2, 1
                                
                                QuestionTypeButton:
                                    text: "Single Choice"
                                    icon: "radiobox-marked"
                                    on_release: root.add_question('choice_single')
                                
                                QuestionTypeButton:
                                    text: "Multiple Choice"
                                    icon: "checkbox-marked"
                                    on_release: root.add_question('choice_multiple')
                            
                            # Date & Time
                            QuestionTypeSection:
                                section_title: "Date & Time"
                                section_icon: "calendar"
                                section_color: 0.2, 0.7, 0.4, 1
                                
                                QuestionTypeButton:
                                    text: "Date"
                                    icon: "calendar"
                                    on_release: root.add_question('date')
                                
                                QuestionTypeButton:
                                    text: "Date & Time"
                                    icon: "calendar-clock"
                                    on_release: root.add_question('datetime')
                            
                            # Location
                            QuestionTypeSection:
                                section_title: "Location"
                                section_icon: "map-marker"
                                section_color: 0.6, 0.2, 0.8, 1
                                
                                QuestionTypeButton:
                                    text: "GPS Point"
                                    icon: "map-marker"
                                    on_release: root.add_question('geopoint')
                                
                                QuestionTypeButton:
                                    text: "GPS Area"
                                    icon: "vector-polygon"
                                    on_release: root.add_question('geoshape')
                            
                            # Media
                            QuestionTypeSection:
                                section_title: "Media"
                                section_icon: "camera"
                                section_color: 0.2, 0.8, 0.8, 1
                                
                                QuestionTypeButton:
                                    text: "Photo"
                                    icon: "camera"
                                    on_release: root.add_question('image')
                                
                                QuestionTypeButton:
                                    text: "Audio"
                                    icon: "microphone"
                                    on_release: root.add_question('audio')
                                
                                QuestionTypeButton:
                                    text: "Video"
                                    icon: "video"
                                    on_release: root.add_question('video')
                                
                                QuestionTypeButton:
                                    text: "File"
                                    icon: "file"
                                    on_release: root.add_question('file')
                            
                            # Special
                            QuestionTypeSection:
                                section_title: "Special"
                                section_icon: "cog"
                                section_color: 0.5, 0.5, 0.5, 1
                                
                                QuestionTypeButton:
                                    text: "Signature"
                                    icon: "signature"
                                    on_release: root.add_question('signature')
                                
                                QuestionTypeButton:
                                    text: "Barcode"
                                    icon: "qrcode"
                                    on_release: root.add_question('barcode')

                # Right Panel - Form Canvas
                MDCard:
                    orientation: 'vertical'
                    size_hint: (0.68, 1)
                    elevation: 2
                    md_bg_color: app.theme_cls.surfaceColor
                    radius: [20, 20, 20, 20]
                    
                    # Form Header
                    MDBoxLayout:
                        orientation: 'horizontal'
                        size_hint_y: None
                        height: dp(72)
                        padding: [dp(20), dp(16)]
                        spacing: dp(16)
                        
                        MDBoxLayout:
                            orientation: 'vertical'
                            size_hint_x: 1
                            
                            MDLabel:
                                text: "Form Builder"
                                font_style: "Headline"
                                role: "small"
                                theme_text_color: "Primary"
                                bold: True
                                size_hint_y: None
                                height: dp(24)
                            
                            MDLabel:
                                text: "Build your form by adding questions"
                                font_style: "Body"
                                role: "small"
                                theme_text_color: "Secondary"
                                size_hint_y: None
                                height: dp(20)
                        
                        # Action Buttons
                        MDButton:
                            style: "filled"
                            md_bg_color: app.theme_cls.primaryColor
                            size_hint: None, None
                            size: dp(100), dp(36)
                            on_release: root.save_form()
                            
                            MDButtonIcon:
                                icon: "content-save"
                            
                            MDButtonText:
                                text: "Save"
                                font_size: "12sp"
                        
                        MDButton:
                            style: "outlined"
                            size_hint: None, None
                            size: dp(90), dp(36)
                            on_release: root.preview_form()
                            
                            MDButtonIcon:
                                icon: "eye"
                            
                            MDButtonText:
                                text: "Preview"
                                font_size: "12sp"
                    
                    # Form Content Area
                    MDScrollView:
                        id: form_scroll
                        do_scroll_x: False
                        bar_width: dp(6)
                        # Using default bar color for KivyMD 2.0.1 compatibility
                        
                        MDBoxLayout:
                            id: form_canvas
                            orientation: 'vertical'
                            spacing: dp(16)  # Reduced spacing between question cards
                            padding: [dp(16), dp(12), dp(16), dp(16)]  # Reduced padding
                            size_hint_y: None
                            height: self.minimum_height
                            
                            # Empty State (will be added programmatically)
                            # EmptyFormState:
                            #     id: empty_state

        # Loading Overlay
        MDCard:
            id: loading_overlay
            md_bg_color: 0, 0, 0, 0.5
            size_hint: 1, 1
            pos_hint: {'center_x': 0.5, 'center_y': 0.5}
            opacity: 0
            elevation: 10
            disabled: True  # Disable touch events when hidden
            
            MDBoxLayout:
                orientation: 'vertical'
                spacing: dp(16)
                
                Widget:
                
                MDCircularProgressIndicator:
                    id: progress_spinner
                    size_hint: None, None
                    size: dp(48), dp(48)
                    pos_hint: {'center_x': 0.5}
                    active: False
                
                MDLabel:
                    id: loading_message
                    text: "Loading..."
                    font_style: "Body"
                    role: "large"
                    theme_text_color: "Custom"
                    text_color: 1, 1, 1, 1
                    halign: "center"
                
                Widget:

# Question Type Section Component
<QuestionTypeSection@MDBoxLayout>:
    section_title: "Section"
    section_icon: "help"
    section_color: 0.5, 0.5, 0.5, 1
    
    orientation: 'vertical'
    spacing: dp(8)
    size_hint_y: None
    height: self.minimum_height
    
    # Section Header
    MDBoxLayout:
        orientation: 'horizontal'
        spacing: dp(10)
        size_hint_y: None
        height: dp(32)
        
        MDIcon:
            icon: root.section_icon
            size_hint: None, None
            size: dp(20), dp(20)
            theme_icon_color: "Custom"
            icon_color: root.section_color
        
        MDLabel:
            text: root.section_title
            font_style: "Title"
            role: "medium"
            theme_text_color: "Primary"
            bold: True
            font_size: "14sp"

# Question Type Button Component
<QuestionTypeButton@MDButton>:
    text: "Question"
    icon: "help"
    
    style: "filled"
    md_bg_color: app.theme_cls.primaryColor
    size_hint_y: None
    height: dp(44)
    
    MDButtonIcon:
        icon: root.icon
    
    MDButtonText:
        text: root.text
        font_size: "13sp"

# Empty Form State
<EmptyFormState@MDCard>:
    orientation: 'vertical'
    spacing: dp(16)
    size_hint_y: None
    height: dp(220)
    pos_hint: {'center_x': 0.5}
    md_bg_color: app.theme_cls.surfaceContainerColor
    elevation: 1
    radius: [16, 16, 16, 16]
    padding: [dp(24), dp(20)]
    
    Widget:
        size_hint_y: None
        height: dp(20)
    
    MDIcon:
        icon: "clipboard-text-outline"
        size_hint: None, None
        size: dp(64), dp(64)
        pos_hint: {'center_x': 0.5}
        theme_icon_color: "Custom"
        icon_color: 0.6, 0.6, 0.6, 1
    
    MDLabel:
        text: "No questions added yet"
        font_style: "Headline"
        role: "small"
        theme_text_color: "Primary"
        halign: "center"
        bold: True
        size_hint_y: None
        height: dp(32)
    
    MDLabel:
        text: "Select question types from the left panel to start building your form"
        font_style: "Body"
        role: "medium"
        theme_text_color: "Secondary"
        halign: "center"
        text_size: self.width, None
        size_hint_y: None
        height: dp(48)

# No Projects State  
<NoProjectsState@MDCard>:
    orientation: 'vertical'
    spacing: dp(20)
    size_hint_y: None
    height: dp(300)
    pos_hint: {'center_x': 0.5}
    md_bg_color: app.theme_cls.surfaceContainerColor
    elevation: 1
    radius: [16, 16, 16, 16]
    padding: [dp(24), dp(20)]
    
    Widget:
        size_hint_y: None
        height: dp(20)
    
    MDIcon:
        icon: "folder-plus-outline"
        size_hint: None, None
        size: dp(72), dp(72)
        pos_hint: {'center_x': 0.5}
        theme_icon_color: "Custom"
        icon_color: 0.5, 0.5, 0.5, 1
    
    MDLabel:
        text: "No Projects Found"
        font_style: "Headline"
        role: "medium"
        theme_text_color: "Primary"
        halign: "center"
        bold: True
        size_hint_y: None
        height: dp(32)
    
    MDLabel:
        text: "Create a project first to start building forms"
        font_style: "Body"
        role: "large"
        theme_text_color: "Secondary"
        halign: "center"
        text_size: self.width, None
        size_hint_y: None
        height: dp(48)
    
    MDButton:
        style: "filled"
        size_hint: None, None
        size: dp(180), dp(48)
        pos_hint: {'center_x': 0.5}
        md_bg_color: app.theme_cls.primaryColor
        on_release: app.root.current = 'project_creation'
        
        MDButtonText:
            text: "Create Project"
        
        MDButtonIcon:
            icon: "plus"