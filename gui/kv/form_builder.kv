<FormBuilderScreen>:
    FloatLayout:
        MDBoxLayout:
            orientation: 'vertical'
            spacing: 0
            size_hint: 1, 1  # Ensure full screen coverage
            md_bg_color: 0.96, 0.96, 0.96, 1

            # Top Bar - Consistent with other screens
            TopBar:
                id: top_bar
                size_hint_y: None
                height: dp(56)

            Widget:
                size_hint_y: None
                height: dp(15)

            # Enhanced Header Bar
            MDCard:
                orientation: 'vertical'
                size_hint_y: None
                height: dp(80)  # Further reduced to save more space
                elevation: 1
                md_bg_color: 1, 1, 1, 1

                # Project Selection Row - Simplified
                MDBoxLayout:
                    orientation: 'horizontal'
                    padding: [dp(20), dp(16), dp(20), dp(16)]
                    spacing: dp(16)
                    size_hint_y: None
                    height: dp(48)

                    MDLabel:
                        text: "Project:"
                        font_style: "Title"

                        role: "large"
                        theme_text_color: "Primary"
                        font_size: "16sp"
                        size_hint_x: None
                        width: dp(80)
                        halign: "left"

                    MDButton:
                        id: project_spinner
                        style: "outlined"
                        size_hint_x: 1
                        height: dp(48)
                        on_release: root.open_project_menu()
                        
                        MDButtonText:
                            text: 'Select Project'
                            font_size: '16sp'
                        
                        MDButtonIcon:
                            icon: "chevron-down"

                # Description Row
                MDBoxLayout:
                    padding: [dp(20), 0, dp(20), dp(16)]
                    size_hint_y: None
                    height: dp(32)

                    MDLabel:
                        text: "Build professional forms with customizable question types"
                        font_style: "Body"

                        role: "medium"
                        theme_text_color: "Secondary"
                        font_size: "14sp"

            # Main Content Area - Properly sized to fill available space
            MDBoxLayout:
                orientation: 'horizontal'
                spacing: dp(16)
                padding: [dp(32), dp(16), dp(32), 0]
                size_hint_y: 1  # This makes it expand to fill available space

                # Left Sidebar - Question Types
                MDCard:
                    id: sidebar_card
                    orientation: 'vertical'
                    size_hint: (0.32, 1)
                    size_hint_y: 1  # Stretch vertically
                    elevation: 1
                    md_bg_color: 1, 1, 1, 1

                    # Sidebar Header
                    MDBoxLayout:
                        orientation: 'vertical'
                        size_hint_y: None
                        height: dp(50)  # Match form canvas header
                        padding: [dp(16), dp(12), dp(16), dp(8)]

                        MDLabel:
                            text: "Question Types"
                            font_style: "Headline"

                            role: "small"
                            bold: True
                            theme_text_color: "Primary"
                            font_size: "18sp"
                            size_hint_y: None
                            height: dp(24)

                        MDLabel:
                            text: "Choose question types to build your form"
                            font_style: "Label"

                            role: "small"
                            theme_text_color: "Secondary"
                            font_size: "12sp"
                            size_hint_y: None
                            height: dp(18)

                    # Scrollable Question Types - Expand to fill remaining space
                    MDScrollView:
                        do_scroll_x: False
                        do_scroll_y: True
                        size_hint: 1, 1  # Fill remaining space in sidebar
                        bar_width: dp(4)
                        bar_color: 0.8, 0.8, 0.8, 1

                        MDBoxLayout:
                            orientation: 'vertical'
                            padding: [dp(16), dp(12), dp(16), dp(16)]
                            spacing: dp(16)  # Reduced spacing for better fit
                            size_hint_y: None
                            height: max(self.minimum_height, self.parent.height)

                            # TEXT RESPONSES SECTION
                            MDBoxLayout:
                                orientation: 'vertical'
                                spacing: dp(12)  # Increased spacing for tablets
                                size_hint_y: None
                                height: self.minimum_height

                                # Section Header
                                MDBoxLayout:
                                    orientation: 'horizontal'
                                    spacing: dp(8)
                                    size_hint_y: None
                                    height: dp(32)  # Larger header for tablets

                                    MDIcon:
                                        icon: "format-text"
                                        size_hint: None, None
                                        size: dp(24), dp(24)  # Larger icon for tablets
                                        theme_icon_color: "Primary"

                                    MDLabel:
                                        text: "Text Responses"
                                        font_style: "Title"

                                        role: "large"
                                        bold: True
                                        theme_text_color: "Primary"
                                        font_size: "16sp"  # Larger font for tablets

                                # Text Response Buttons - Tablet optimized
                                MDButton:
                                    style: "filled"
                                    on_release: root.add_question('text_short')
                                    size_hint_y: None
                                    height: dp(48)
                                    md_bg_color: 0.2, 0.6, 1, 1
                                    elevation: 1
                                    
                                    MDButtonIcon:
                                        icon: "text-short"
                                    
                                    MDButtonText:
                                        text: "Short Text"
                                        font_size: "15sp"

                                MDButton:
                                    style: "filled"
                                    on_release: root.add_question('text_long')
                                    size_hint_y: None
                                    height: dp(48)
                                    md_bg_color: 0.2, 0.6, 1, 1
                                    elevation: 1
                                    
                                    MDButtonIcon:
                                        icon: "text-long"
                                    
                                    MDButtonText:
                                        text: "Long Text"
                                        font_size: "15sp"

                            # NUMERIC RESPONSES SECTION
                            MDBoxLayout:
                                orientation: 'vertical'
                                spacing: dp(12)  # Increased spacing for tablets
                                size_hint_y: None
                                height: self.minimum_height

                                # Section Header
                                MDBoxLayout:
                                    orientation: 'horizontal'
                                    spacing: dp(8)
                                    size_hint_y: None
                                    height: dp(32)  # Larger header for tablets

                                    MDIcon:
                                        icon: "numeric"
                                        size_hint: None, None
                                        size: dp(24), dp(24)  # Larger icon for tablets
                                        theme_icon_color: "Primary"

                                    MDLabel:
                                        text: "Numeric Responses"
                                        font_style: "Title"

                                        role: "large"
                                        bold: True
                                        theme_text_color: "Primary"
                                        font_size: "16sp"  # Larger font for tablets

                                # Numeric Response Buttons - Modern design
                                MDButton:
                                    style: "filled"
                                    on_release: root.add_question('numeric_integer')
                                    size_hint_y: None
                                    height: dp(48)
                                    md_bg_color: 1, 0.6, 0.2, 1
                                    elevation: 1
                                    
                                    MDButtonIcon:
                                        icon: "numeric"
                                    
                                    MDButtonText:
                                        text: "Number (Integer)"
                                        font_size: "15sp"

                                MDButton:
                                    style: "filled"
                                    on_release: root.add_question('numeric_decimal')
                                    size_hint_y: None
                                    height: dp(48)
                                    md_bg_color: 1, 0.6, 0.2, 1
                                    elevation: 1
                                    
                                    MDButtonIcon:
                                        icon: "numeric-9-plus"
                                    
                                    MDButtonText:
                                        text: "Number (Decimal)"
                                        font_size: "15sp"

                            # CHOICE RESPONSES SECTION
                            MDBoxLayout:
                                orientation: 'vertical'
                                spacing: dp(8)  # Reduced spacing
                                size_hint_y: None
                                height: self.minimum_height

                                # Section Header
                                MDBoxLayout:
                                    orientation: 'horizontal'
                                    spacing: dp(8)
                                    size_hint_y: None
                                    height: dp(28)  # Smaller header

                                    MDIcon:
                                        icon: "check-circle-outline"
                                        size_hint: None, None
                                        size: dp(18), dp(18)  # Smaller icon
                                        theme_icon_color: "Primary"

                                    MDLabel:
                                        text: "Choice Responses"
                                        font_style: "Title"

                                        role: "large"
                                        bold: True
                                        theme_text_color: "Primary"
                                        font_size: "15sp"  # Smaller font

                                # Choice Response Buttons
                                MDButton:
                                    style: "filled"
                                    on_release: root.add_question('choice_single')
                                    size_hint_y: None
                                    height: dp(36)
                                    md_bg_color: 0.8, 0.4, 0.2, 1
                                    elevation: 1
                                    
                                    MDButtonIcon:
                                        icon: "radiobox-marked"
                                    
                                    MDButtonText:
                                        text: "Single Choice"
                                        font_size: "13sp"

                                MDButton:
                                    style: "filled"
                                    on_release: root.add_question('choice_multiple')
                                    size_hint_y: None
                                    height: dp(36)
                                    md_bg_color: 0.8, 0.4, 0.2, 1
                                    elevation: 1
                                    
                                    MDButtonIcon:
                                        icon: "checkbox-marked"
                                    
                                    MDButtonText:
                                        text: "Multiple Choice"
                                        font_size: "13sp"

                            # DATE & TIME SECTION
                            MDBoxLayout:
                                orientation: 'vertical'
                                spacing: dp(8)  # Reduced spacing
                                size_hint_y: None
                                height: self.minimum_height

                                # Section Header
                                MDBoxLayout:
                                    orientation: 'horizontal'
                                    spacing: dp(8)
                                    size_hint_y: None
                                    height: dp(28)  # Smaller header

                                    MDIcon:
                                        icon: "calendar"
                                        size_hint: None, None
                                        size: dp(18), dp(18)  # Smaller icon
                                        theme_icon_color: "Primary"

                                    MDLabel:
                                        text: "Date & Time"
                                        font_style: "Title"

                                        role: "large"
                                        bold: True
                                        theme_text_color: "Primary"
                                        font_size: "15sp"  # Smaller font

                                # Date & Time Buttons
                                MDButton:
                                    style: "elevated"
                                    on_release: root.add_question('date')
                                    size_hint_y: None
                                    height: dp(36)
                                    md_bg_color: 0.2, 0.7, 0.4, 1
                                    font_size: "13sp"
                                    elevation: 1
                                    
                                    MDButtonText:
                                        text: "Date"

                                MDButton:
                                    style: "elevated"
                                    on_release: root.add_question('datetime')
                                    size_hint_y: None
                                    height: dp(36)
                                    md_bg_color: 0.2, 0.7, 0.4, 1
                                    font_size: "13sp"
                                    elevation: 1
                                    
                                    MDButtonText:
                                        text: "Date & Time"

                            # LOCATION & GPS SECTION
                            MDBoxLayout:
                                orientation: 'vertical'
                                spacing: dp(8)
                                size_hint_y: None
                                height: self.minimum_height

                                # Section Header
                                MDBoxLayout:
                                    orientation: 'horizontal'
                                    spacing: dp(8)
                                    size_hint_y: None
                                    height: dp(28)

                                    MDIcon:
                                        icon: "map-marker"
                                        size_hint: None, None
                                        size: dp(18), dp(18)
                                        theme_icon_color: "Primary"

                                    MDLabel:
                                        text: "Location & GPS"
                                        font_style: "Title"

                                        role: "large"
                                        bold: True
                                        theme_text_color: "Primary"
                                        font_size: "15sp"

                                # Location Buttons
                                MDButton:
                                    style: "elevated"
                                    on_release: root.add_question('geopoint')
                                    size_hint_y: None
                                    height: dp(36)
                                    md_bg_color: 0.6, 0.2, 0.8, 1
                                    font_size: "13sp"
                                    elevation: 1
                                    
                                    MDButtonText:
                                        text: "GPS Location"

                                MDButton:
                                    style: "elevated"
                                    on_release: root.add_question('geoshape')
                                    size_hint_y: None
                                    height: dp(36)
                                    md_bg_color: 0.6, 0.2, 0.8, 1
                                    font_size: "13sp"
                                    elevation: 1
                                    
                                    MDButtonText:
                                        text: "GPS Area"

                            # MEDIA SECTION
                            MDBoxLayout:
                                orientation: 'vertical'
                                spacing: dp(8)
                                size_hint_y: None
                                height: self.minimum_height

                                # Section Header
                                MDBoxLayout:
                                    orientation: 'horizontal'
                                    spacing: dp(8)
                                    size_hint_y: None
                                    height: dp(28)

                                    MDIcon:
                                        icon: "camera"
                                        size_hint: None, None
                                        size: dp(18), dp(18)
                                        theme_icon_color: "Primary"

                                    MDLabel:
                                        text: "Media & Files"
                                        font_style: "Title"

                                        role: "large"
                                        bold: True
                                        theme_text_color: "Primary"
                                        font_size: "15sp"

                                # Media Buttons
                                MDButton:
                                    style: "elevated"
                                    on_release: root.add_question('image')
                                    size_hint_y: None
                                    height: dp(36)
                                    md_bg_color: 0.2, 0.8, 0.8, 1
                                    font_size: "13sp"
                                    elevation: 1
                                    
                                    MDButtonText:
                                        text: "Photo/Image"

                                MDButton:
                                    style: "elevated"
                                    on_release: root.add_question('audio')
                                    size_hint_y: None
                                    height: dp(36)
                                    md_bg_color: 0.2, 0.8, 0.8, 1
                                    font_size: "13sp"
                                    elevation: 1
                                    
                                    MDButtonText:
                                        text: "Audio Recording"

                                MDButton:
                                    style: "elevated"
                                    on_release: root.add_question('video')
                                    size_hint_y: None
                                    height: dp(36)
                                    md_bg_color: 0.2, 0.8, 0.8, 1
                                    font_size: "13sp"
                                    elevation: 1
                                    
                                    MDButtonText:
                                        text: "Video Recording"

                                MDButton:
                                    style: "elevated"
                                    on_release: root.add_question('file')
                                    size_hint_y: None
                                    height: dp(36)
                                    md_bg_color: 0.2, 0.8, 0.8, 1
                                    font_size: "13sp"
                                    elevation: 1
                                    
                                    MDButtonText:
                                        text: "File Upload"

                            # SPECIAL SECTION
                            MDBoxLayout:
                                orientation: 'vertical'
                                spacing: dp(8)
                                size_hint_y: None
                                height: self.minimum_height

                                # Section Header
                                MDBoxLayout:
                                    orientation: 'horizontal'
                                    spacing: dp(8)
                                    size_hint_y: None
                                    height: dp(28)

                                    MDIcon:
                                        icon: "cog"
                                        size_hint: None, None
                                        size: dp(18), dp(18)
                                        theme_icon_color: "Primary"

                                    MDLabel:
                                        text: "Special Types"
                                        font_style: "Title"

                                        role: "large"
                                        bold: True
                                        theme_text_color: "Primary"
                                        font_size: "15sp"

                                # Special Buttons
                                MDButton:
                                    style: "elevated"
                                    on_release: root.add_question('signature')
                                    size_hint_y: None
                                    height: dp(36)
                                    md_bg_color: 0.4, 0.4, 0.4, 1
                                    font_size: "13sp"
                                    elevation: 1
                                    
                                    MDButtonText:
                                        text: "Digital Signature"

                                MDButton:
                                    style: "elevated"
                                    on_release: root.add_question('barcode')
                                    size_hint_y: None
                                    height: dp(36)
                                    md_bg_color: 0.4, 0.4, 0.4, 1
                                    font_size: "13sp"
                                    elevation: 1
                                    
                                    MDButtonText:
                                        text: "Barcode/QR Code"

                                MDButton:
                                    style: "elevated"
                                    on_release: root.add_question('scale_rating')
                                    size_hint_y: None
                                    height: dp(36)
                                    md_bg_color: 0.4, 0.4, 0.4, 1
                                    font_size: "13sp"
                                    elevation: 1
                                    
                                    MDButtonText:
                                        text: "Rating Scale"

                # Right Panel - Form Canvas
                MDCard:
                    orientation: 'vertical'
                    size_hint: (0.68, 1)
                    size_hint_y: 1  # Stretch vertically
                    elevation: 1
                    md_bg_color: 1, 1, 1, 1

                    # Form Canvas Header - Simplified
                    MDBoxLayout:
                        orientation: 'vertical'
                        size_hint_y: None
                        height: dp(50)  # Further reduced
                        padding: [dp(16), dp(12), dp(16), dp(8)]

                        MDLabel:
                            text: "Form Questions"
                            font_style: "Headline"

                            role: "small"
                            bold: True
                            theme_text_color: "Primary"
                            font_size: "18sp"
                            size_hint_y: None
                            height: dp(24)

                        MDLabel:
                            text: "Add questions from the left panel to build your form"
                            font_style: "Body"

                            role: "medium"
                            theme_text_color: "Secondary"
                            font_size: "14sp"
                            size_hint_y: None
                            height: dp(18)

                    # Form Canvas Content Area - Expand to fill remaining space
                    MDScrollView:
                        do_scroll_x: False
                        do_scroll_y: True
                        size_hint: 1, 1  # Fill remaining space
                        bar_width: dp(4)
                        bar_color: 0.8, 0.8, 0.8, 1

                        MDBoxLayout:
                            id: form_canvas
                            orientation: 'vertical'
                            spacing: dp(24)
                            size_hint_y: None
                            height: max(self.minimum_height, self.parent.height)
                            padding: [dp(24), dp(24), dp(24), dp(24)]

                            # Empty state when no questions
                            MDBoxLayout:
                                id: empty_state
                                orientation: 'vertical'
                                spacing: dp(16)
                                size_hint_y: None
                                height: dp(200)

                                Widget:
                                    size_hint_y: None
                                    height: dp(40)

                                MDIcon:
                                    icon: "clipboard-text-outline"
                                    size_hint: None, None
                                    size: dp(64), dp(64)
                                    pos_hint: {'center_x': 0.5}
                                    theme_icon_color: "Hint"

                                MDLabel:
                                    text: "No questions added yet"
                                    font_style: "Headline"

                                    role: "small"
                                    theme_text_color: "Hint"
                                    halign: "center"
                                    font_size: "18sp"

                                MDLabel:
                                    text: "Select question types from the left panel to start building your form"
                                    font_style: "Body"

                                    role: "medium"
                                    theme_text_color: "Hint"
                                    halign: "center"
                                    font_size: "14sp"

            # Footer - Action buttons at bottom
            MDCard:
                orientation: 'horizontal'
                size_hint_y: None
                height: dp(50)  # Further reduced for maximum content space
                padding: [dp(20), dp(8)]
                spacing: dp(16)
                elevation: 2
                md_bg_color: 1, 1, 1, 1

                Widget:
                    size_hint_x: 1

                MDButton:
                    style: "filled"
                    md_bg_color: 0.27, 0.65, 0.27, 1
                    size_hint: None, None
                    size: dp(120), dp(40)
                    elevation: 2
                    on_release: root.save_form()
                    
                    MDButtonIcon:
                        icon: "content-save"
                    
                    MDButtonText:
                        text: "Save Form"
                        font_size: "14sp"

                MDButton:
                    style: "filled"
                    md_bg_color: 0.4, 0.4, 0.9, 1
                    size_hint: None, None
                    size: dp(100), dp(40)
                    elevation: 2
                    on_release: root.preview_questions()
                    
                    MDButtonIcon:
                        icon: "eye"
                    
                    MDButtonText:
                        text: "Preview"
                        font_size: "14sp"

                Widget:
                    size_hint_x: 1

        # Loading Overlay (floats above content, does not affect layout)
        MDBoxLayout:
            id: loading_overlay
            orientation: 'vertical'
            md_bg_color: 0, 0, 0, 0.3
            size_hint: 1, 1
            pos_hint: {'center_x': 0.5, 'center_y': 0.5}
            opacity: 0

            Widget:

            MDCircularProgressIndicator:
                id: spinner
                size_hint: None, None
                size: dp(48), dp(48)
                pos_hint: {'center_x': 0.5, 'center_y': 0.5}
                active: False

            MDLabel:
                text: "Processing..."
                font_style: "Body"

                role: "large"
                theme_text_color: "Custom"
                text_color: 1, 1, 1, 1
                halign: "center"
                font_size: "16sp"

            Widget:

# Modern KV Components for Form Builder States

<NoProjectsState@MDCard>:
    orientation: 'vertical'
    size_hint_y: None
    height: dp(280)
    elevation: 0
    md_bg_color: 0.98, 0.98, 0.98, 1
    radius: [16, 16, 16, 16]
    padding: [dp(32), dp(24)]
    spacing: dp(20)
    pos_hint: {'center_x': 0.5}
    
    Widget:
        size_hint_y: None
        height: dp(16)
    
    MDIcon:
        icon: "folder-plus-outline"
        size_hint: None, None
        size: dp(64), dp(64)
        pos_hint: {'center_x': 0.5}
        theme_icon_color: "Custom"
        icon_color: 0.6, 0.6, 0.6, 1
    
    MDLabel:
        text: "No Projects Found"
        font_style: "Headline"

        role: "medium"
        theme_text_color: "Primary"
        halign: "center"
        bold: True
        size_hint_y: None
        height: dp(32)
    
    MDLabel:
        text: "To create forms, you need to have at least one project.\nGo to the Projects page to create a new project first."
        font_style: "Body"

        role: "large"
        theme_text_color: "Secondary"
        halign: "center"
        text_size: self.width, None
        size_hint_y: None
        height: dp(60)
    
    MDButton:
        style: "filled"
        size_hint: None, None
        size: dp(160), dp(48)
        pos_hint: {'center_x': 0.5}
        md_bg_color: app.theme_cls.primaryColor
        on_release: setattr(app.root, 'current', 'projects')
        
        MDButtonText:
            text: "Go to Projects"
        
        MDButtonIcon:
            icon: "arrow-right"

<EmptyFormState@MDCard>:
    orientation: 'vertical'
    size_hint_y: None
    height: dp(240)
    elevation: 0
    md_bg_color: 0.98, 0.98, 0.98, 1
    radius: [16, 16, 16, 16]
    padding: [dp(32), dp(24)]
    spacing: dp(16)
    pos_hint: {'center_x': 0.5}
    
    Widget:
        size_hint_y: None
        height: dp(12)
    
    MDIcon:
        icon: "clipboard-text-outline"
        size_hint: None, None
        size: dp(56), dp(56)
        pos_hint: {'center_x': 0.5}
        theme_icon_color: "Custom"
        icon_color: 0.7, 0.7, 0.7, 1
    
    MDLabel:
        text: "No questions added yet"
        font_style: "Headline"

        role: "small"
        theme_text_color: "Secondary"
        halign: "center"
        bold: True
        size_hint_y: None
        height: dp(28)
    
    MDLabel:
        text: "Select question types from the left panel to start building your form"
        font_style: "Body"

        role: "medium"
        theme_text_color: "Secondary"
        halign: "center"
        text_size: self.width, None
        size_hint_y: None
        height: dp(48)

<FormPreviewContent@MDScrollView>:
    questions_data: []
    
    MDBoxLayout:
        orientation: 'vertical'
        spacing: dp(16)
        padding: [dp(16), dp(16)]
        size_hint_y: None
        adaptive_height: True
        
        MDLabel:
            text: "Form Preview" if root.questions_data else "No questions to preview"
            font_style: "Headline"

            role: "small" if root.questions_data else "Subtitle1"
            theme_text_color: "Primary" if root.questions_data else "Secondary"
            halign: "left"
            size_hint_y: None
            height: dp(32)
