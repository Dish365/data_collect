<FormBuilderScreen>:
    MDBoxLayout:
        orientation: 'vertical'
        spacing: 0  # Remove spacing between major sections
        md_bg_color: 0.96, 0.96, 0.96, 1  # Clean light gray background

        # Enhanced Header Bar
        MDCard:
            orientation: 'vertical'
            size_hint_y: None
            height: dp(90)
            elevation: 2
            md_bg_color: 1, 1, 1, 1

            # Navigation and Title Row
            MDBoxLayout:
                orientation: 'horizontal'
                padding: [dp(20), dp(12), dp(20), dp(6)]  # Reduced padding
                spacing: dp(16)
                size_hint_y: None
                height: dp(48)  # Reduced from 56 to 48

                MDIconButton:
                    icon: "arrow-left"
                    theme_icon_color: "Primary"
                    size_hint: None, None
                    size: dp(40), dp(40)
                    on_release: setattr(root.manager, 'current', 'dashboard')

                MDLabel:
                    text: "Form Builder"
                    font_style: "H5"
                    bold: True
                    theme_text_color: "Primary"
                    font_size: "24sp"
                    size_hint_x: None
                    width: dp(200)

                Widget:

                MDLabel:
                    text: "Project:"
                    font_style: "Subtitle1"
                    theme_text_color: "Secondary"
                    font_size: "16sp"
                    size_hint_x: None
                    width: dp(80)
                    halign: "right"

                MDDropDownItem:
                    id: project_spinner
                    text: 'Select Project'
                    on_release: root.open_project_menu()
                    size_hint_x: None
                    width: dp(200)
                    font_size: '16sp'

            # Subtitle Row
            MDBoxLayout:
                padding: [dp(76), 0, dp(20), dp(8)]
                size_hint_y: None
                height: dp(36)

                MDLabel:
                    text: "Build professional forms with customizable question types"
                    font_style: "Body2"
                    theme_text_color: "Secondary"
                    font_size: "14sp"

        # Main Content Area - Explicit height and spacing
        MDBoxLayout:
            orientation: 'horizontal'
            spacing: dp(16)
            padding: [dp(16), dp(8), dp(16), dp(8)]
            size_hint_y: 1  # Fill available space between header and footer

            # Left Sidebar - Question Types
            MDCard:
                orientation: 'vertical'
                size_hint: (0.32, 1)  # 32% width, full height
                elevation: 1
                md_bg_color: 1, 1, 1, 1

                # Sidebar Header
                MDBoxLayout:
                    orientation: 'vertical'
                    size_hint_y: None
                    height: dp(70)
                    padding: [dp(20), dp(16), dp(20), dp(12)]

                    MDLabel:
                        text: "Question Types"
                        font_style: "H6"
                        bold: True
                        theme_text_color: "Primary"
                        font_size: "20sp"
                        size_hint_y: None
                        height: dp(28)

                    MDLabel:
                        text: "Choose from various question types to build your form"
                        font_style: "Caption"
                        theme_text_color: "Secondary"
                        font_size: "12sp"
                        size_hint_y: None
                        height: dp(16)

                # Scrollable Question Types with proper spacing
                MDScrollView:
                    do_scroll_x: False
                    bar_width: dp(4)
                    bar_color: 0.8, 0.8, 0.8, 1

                    MDBoxLayout:
                        orientation: 'vertical'
                        padding: [dp(16), dp(12), dp(16), dp(16)]
                        spacing: dp(16)
                        size_hint_y: None
                        height: self.minimum_height

                        # TEXT RESPONSES SECTION
                        MDBoxLayout:
                            orientation: 'vertical'
                            spacing: dp(8)  # Reduced spacing for more compact layout
                            size_hint_y: None
                            height: self.minimum_height

                            # Section Header
                            MDBoxLayout:
                                orientation: 'horizontal'
                                spacing: dp(8)
                                size_hint_y: None
                                height: dp(28)  # Smaller header

                                MDIcon:
                                    icon: "format-text"
                                    size_hint: None, None
                                    size: dp(18), dp(18)  # Smaller icon
                                    theme_icon_color: "Primary"

                                MDLabel:
                                    text: "Text Responses"
                                    font_style: "Subtitle1"
                                    bold: True
                                    theme_text_color: "Primary"
                                    font_size: "15sp"  # Smaller font

                            # Text Response Buttons
                            MDRaisedButton:
                                text: "Short Text"
                                on_release: root.add_question('text_short')
                                size_hint_y: None
                                height: dp(36)  # Smaller buttons
                                md_bg_color: 0.2, 0.6, 1, 1
                                font_size: "13sp"
                                elevation: 1

                            MDRaisedButton:
                                text: "Long Text"
                                on_release: root.add_question('text_long')
                                size_hint_y: None
                                height: dp(36)  # Smaller buttons
                                md_bg_color: 0.2, 0.6, 1, 1
                                font_size: "13sp"
                                elevation: 1

                        # NUMERIC RESPONSES SECTION
                        MDBoxLayout:
                            orientation: 'vertical'
                            spacing: dp(8)  # Reduced spacing
                            size_hint_y: None
                            height: self.minimum_height

                            # Section Header
                            MDBoxLayout:
                                orientation: 'horizontal'
                                spacing: dp(8)
                                size_hint_y: None
                                height: dp(28)  # Smaller header

                                MDIcon:
                                    icon: "numeric"
                                    size_hint: None, None
                                    size: dp(18), dp(18)  # Smaller icon
                                    theme_icon_color: "Primary"

                                MDLabel:
                                    text: "Numeric Responses"
                                    font_style: "Subtitle1"
                                    bold: True
                                    theme_text_color: "Primary"
                                    font_size: "15sp"  # Smaller font

                            # Numeric Response Buttons
                            MDRaisedButton:
                                text: "Number (Integer)"
                                on_release: root.add_question('numeric_integer')
                                size_hint_y: None
                                height: dp(36)
                                md_bg_color: 1, 0.6, 0.2, 1
                                font_size: "13sp"
                                elevation: 1

                            MDRaisedButton:
                                text: "Number (Decimal)"
                                on_release: root.add_question('numeric_decimal')
                                size_hint_y: None
                                height: dp(36)
                                md_bg_color: 1, 0.6, 0.2, 1
                                font_size: "13sp"
                                elevation: 1

                            MDRaisedButton:
                                text: "Rating Scale"
                                on_release: root.add_question('scale_rating')
                                size_hint_y: None
                                height: dp(36)
                                md_bg_color: 1, 0.6, 0.2, 1
                                font_size: "13sp"
                                elevation: 1

                        # CHOICE RESPONSES SECTION
                        MDBoxLayout:
                            orientation: 'vertical'
                            spacing: dp(8)  # Reduced spacing
                            size_hint_y: None
                            height: self.minimum_height

                            # Section Header
                            MDBoxLayout:
                                orientation: 'horizontal'
                                spacing: dp(8)
                                size_hint_y: None
                                height: dp(28)  # Smaller header

                                MDIcon:
                                    icon: "check-circle-outline"
                                    size_hint: None, None
                                    size: dp(18), dp(18)  # Smaller icon
                                    theme_icon_color: "Primary"

                                MDLabel:
                                    text: "Choice Responses"
                                    font_style: "Subtitle1"
                                    bold: True
                                    theme_text_color: "Primary"
                                    font_size: "15sp"  # Smaller font

                            # Choice Response Buttons
                            MDRaisedButton:
                                text: "Single Choice"
                                on_release: root.add_question('choice_single')
                                size_hint_y: None
                                height: dp(36)
                                md_bg_color: 0.8, 0.4, 0.2, 1
                                font_size: "13sp"
                                elevation: 1

                            MDRaisedButton:
                                text: "Multiple Choice"
                                on_release: root.add_question('choice_multiple')
                                size_hint_y: None
                                height: dp(36)
                                md_bg_color: 0.8, 0.4, 0.2, 1
                                font_size: "13sp"
                                elevation: 1

                        # DATE & TIME SECTION
                        MDBoxLayout:
                            orientation: 'vertical'
                            spacing: dp(8)  # Reduced spacing
                            size_hint_y: None
                            height: self.minimum_height

                            # Section Header
                            MDBoxLayout:
                                orientation: 'horizontal'
                                spacing: dp(8)
                                size_hint_y: None
                                height: dp(28)  # Smaller header

                                MDIcon:
                                    icon: "calendar"
                                    size_hint: None, None
                                    size: dp(18), dp(18)  # Smaller icon
                                    theme_icon_color: "Primary"

                                MDLabel:
                                    text: "Date & Time"
                                    font_style: "Subtitle1"
                                    bold: True
                                    theme_text_color: "Primary"
                                    font_size: "15sp"  # Smaller font

                            # Date & Time Buttons
                            MDRaisedButton:
                                text: "Date"
                                on_release: root.add_question('date')
                                size_hint_y: None
                                height: dp(36)
                                md_bg_color: 0.2, 0.7, 0.4, 1
                                font_size: "13sp"
                                elevation: 1

                            MDRaisedButton:
                                text: "Date & Time"
                                on_release: root.add_question('datetime')
                                size_hint_y: None
                                height: dp(36)
                                md_bg_color: 0.2, 0.7, 0.4, 1
                                font_size: "13sp"
                                elevation: 1

                        # SPECIAL SECTION
                        MDBoxLayout:
                            orientation: 'vertical'
                            spacing: dp(8)  # Reduced spacing
                            size_hint_y: None
                            height: self.minimum_height

                            # Section Header
                            MDBoxLayout:
                                orientation: 'horizontal'
                                spacing: dp(8)
                                size_hint_y: None
                                height: dp(28)  # Smaller header

                                MDIcon:
                                    icon: "cog"
                                    size_hint: None, None
                                    size: dp(18), dp(18)  # Smaller icon
                                    theme_icon_color: "Primary"

                                MDLabel:
                                    text: "Special Types"
                                    font_style: "Subtitle1"
                                    bold: True
                                    theme_text_color: "Primary"
                                    font_size: "15sp"  # Smaller font

                            # Special Buttons
                            MDRaisedButton:
                                text: "GPS Location"
                                on_release: root.add_question('geopoint')
                                size_hint_y: None
                                height: dp(36)
                                md_bg_color: 0.6, 0.2, 0.8, 1
                                font_size: "13sp"
                                elevation: 1

                            MDRaisedButton:
                                text: "Photo/Image"
                                on_release: root.add_question('image')
                                size_hint_y: None
                                height: dp(36)
                                md_bg_color: 0.2, 0.8, 0.8, 1
                                font_size: "13sp"
                                elevation: 1

                            MDRaisedButton:
                                text: "Audio Recording"
                                on_release: root.add_question('audio')
                                size_hint_y: None
                                height: dp(36)
                                md_bg_color: 0.2, 0.8, 0.8, 1
                                font_size: "13sp"
                                elevation: 1

                            MDRaisedButton:
                                text: "Barcode/QR Code"
                                on_release: root.add_question('barcode')
                                size_hint_y: None
                                height: dp(36)
                                md_bg_color: 0.4, 0.4, 0.4, 1
                                font_size: "13sp"
                                elevation: 1

            # Right Panel - Form Canvas
            MDCard:
                orientation: 'vertical'
                size_hint: (0.68, 1)  # 68% width, full height
                elevation: 1
                md_bg_color: 1, 1, 1, 1

                # Form Canvas Header
                MDBoxLayout:
                    orientation: 'vertical'
                    size_hint_y: None
                    height: dp(70)
                    padding: [dp(20), dp(16), dp(20), dp(12)]

                    MDBoxLayout:
                        orientation: 'horizontal'
                        size_hint_y: None
                        height: dp(32)

                        MDLabel:
                            text: "Form Questions"
                            font_style: "H6"
                            bold: True
                            theme_text_color: "Primary"
                            font_size: "20sp"

                        Widget:

                        MDChip:
                            text: "0 Questions"
                            id: question_count_chip
                            size_hint: None, None
                            size: dp(100), dp(32)

                    MDLabel:
                        text: "Add questions from the left panel to build your form"
                        font_style: "Body2"
                        theme_text_color: "Secondary"
                        font_size: "14sp"
                        size_hint_y: None
                        height: dp(20)

                # Form Canvas Content Area with proper spacing
                MDScrollView:
                    do_scroll_x: False
                    do_scroll_y: True
                    bar_width: dp(4)
                    bar_color: 0.8, 0.8, 0.8, 1
                    size_hint_y: 1

                    MDBoxLayout:
                        id: form_canvas
                        orientation: 'vertical'
                        spacing: dp(16)
                        adaptive_height: True
                        padding: [dp(20), dp(16), dp(20), dp(20)]

                        # Empty state when no questions
                        MDBoxLayout:
                            id: empty_state
                            orientation: 'vertical'
                            spacing: dp(16)
                            size_hint_y: None
                            height: dp(200)

                            Widget:
                                size_hint_y: None
                                height: dp(40)

                            MDIcon:
                                icon: "clipboard-text-outline"
                                size_hint: None, None
                                size: dp(64), dp(64)
                                pos_hint: {'center_x': 0.5}
                                theme_icon_color: "Hint"

                            MDLabel:
                                text: "No questions added yet"
                                font_style: "H6"
                                theme_text_color: "Hint"
                                halign: "center"
                                font_size: "18sp"

                            MDLabel:
                                text: "Select question types from the left panel to start building your form"
                                font_style: "Body2"
                                theme_text_color: "Hint"
                                halign: "center"
                                font_size: "14sp"

        # Footer - Fixed at bottom
        MDCard:
            orientation: 'horizontal'
            size_hint_y: None
            height: dp(64)
            padding: [dp(16), dp(8)]
            spacing: dp(12)
            elevation: 2
            md_bg_color: 1, 1, 1, 1

            Widget:
                size_hint_x: 0.4

            MDRaisedButton:
                text: "Save Form"
                icon: "content-save"
                md_bg_color: 0.27, 0.65, 0.27, 1
                font_size: "14sp"
                size_hint: None, None
                size: dp(120), dp(36)
                elevation: 1
                on_release: root.save_form()
                pos_hint: {'center_y': 0.5}

            MDRaisedButton:
                text: "Preview"
                icon: "eye"
                md_bg_color: 0.4, 0.4, 0.9, 1
                font_size: "14sp"
                size_hint: None, None
                size: dp(100), dp(36)
                elevation: 1
                on_release: root.preview_questions()
                pos_hint: {'center_y': 0.5}

            Widget:
                size_hint_x: 0.4

        # Loading Overlay
        MDBoxLayout:
            id: loading_overlay
            orientation: 'vertical'
            md_bg_color: 0, 0, 0, 0.3
            size_hint: 1, 1
            pos_hint: {'center_x': 0.5, 'center_y': 0.5}
            opacity: 0

            Widget:

            MDSpinner:
                id: spinner
                size_hint: None, None
                size: dp(48), dp(48)
                pos_hint: {'center_x': 0.5, 'center_y': 0.5}
                active: False

            MDLabel:
                text: "Processing..."
                font_style: "Body1"
                theme_text_color: "Custom"
                text_color: 1, 1, 1, 1
                halign: "center"
                font_size: "16sp"

            Widget:
