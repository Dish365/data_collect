#:import dp kivy.metrics.dp

<ProjectsScreen>:
    name: "projects"

    MDBoxLayout:
        orientation: "vertical"
        spacing: dp(12)

        # Modern TopBar with enhanced styling
        TopBar:
            id: top_bar
            size_hint_y: None
            height: dp(64)

        # Main content layout with modern design
        MDBoxLayout:
            orientation: "vertical"
            id: content_layout
            padding: dp(16)
            spacing: dp(20)

            # Enhanced Header Section with modern cards
            MDCard:
                orientation: "vertical"
                adaptive_height: True
                size_hint_y: None
                height: self.minimum_height
                padding: dp(20)
                spacing: dp(20)
                elevation: 3
                radius: dp(16)
                md_bg_color: app.theme_cls.surfaceContainerColor

                # Title and Navigation Row
                MDBoxLayout:
                    orientation: "horizontal"
                    adaptive_height: True
                    size_hint_y: None
                    height: dp(56)
                    spacing: dp(16)

                    # Left Section: Back arrow + Title
                    MDBoxLayout:
                        orientation: "horizontal"
                        adaptive_width: True
                        size_hint_x: None
                        width: self.minimum_width
                        spacing: dp(12)
                        pos_hint: {"center_y": 0.5}

                        MDIconButton:
                            icon: "arrow-left"
                            size_hint: None, None
                            size: dp(48), dp(48)
                            theme_icon_color: "Primary"
                            pos_hint: {"center_y": 0.5}
                            on_release:
                                root.manager.transition.direction = "right"
                                root.manager.current = "dashboard"

                        MDLabel:
                            text: "Projects"
                            theme_font_size: "Custom"
                            font_size: dp(24)
                            bold: True
                            theme_text_color: "Primary"
                            pos_hint: {"center_y": 0.5}
                            adaptive_width: True
                            size_hint_x: None
                            width: self.texture_size[0]

                    Widget:  # Spacer

                    # Right Section: Action buttons
                    MDBoxLayout:
                        orientation: "horizontal"
                        adaptive_width: True
                        size_hint_x: None
                        width: self.minimum_width
                        spacing: dp(12)
                        pos_hint: {"center_y": 0.5}

                        MDButton:
                            style: "filled"
                            size_hint: None, None
                            size: dp(140), dp(48)
                            on_release: root.open_project_dialog()

                            MDButtonText:
                                text: "New Project"
                                theme_font_size: "Custom"
                                font_size: dp(14)

                        MDIconButton:
                            icon: "refresh"
                            size_hint: None, None
                            size: dp(48), dp(48)
                            theme_icon_color: "Primary"
                            pos_hint: {"center_y": 0.5}
                            on_release: root.check_and_sync_projects()

                # Search Section
                MDTextField:
                    id: search_field
                    mode: "outlined"
                    size_hint_y: None
                    height: dp(56)
                    on_text: root.search_projects(self.text)

                    MDTextFieldHintText:
                        text: "Search projects by name..."

                # Filter and Sort Toolbar
                MDCard:
                    orientation: "horizontal"
                    adaptive_height: True
                    size_hint_y: None
                    height: dp(64)
                    padding: dp(12)
                    spacing: dp(12)
                    elevation: 1
                    radius: dp(12)
                    md_bg_color: app.theme_cls.surfaceContainerLowColor

                    MDLabel:
                        text: "Filter:"
                        theme_font_size: "Custom"
                        font_size: dp(14)
                        bold: True
                        theme_text_color: "Primary"
                        size_hint_x: None
                        width: dp(60)
                        pos_hint: {"center_y": 0.5}

                    MDButton:
                        id: filter_all_btn
                        style: "filled"
                        size_hint_x: None
                        width: dp(100)
                        size_hint_y: None
                        height: dp(40)
                        on_release: root.filter_projects("all")

                        MDButtonText:
                            text: "All"
                            theme_font_size: "Custom"
                            font_size: dp(12)

                    MDButton:
                        id: filter_recent_btn
                        style: "outlined"
                        size_hint_x: None
                        width: dp(100)
                        size_hint_y: None
                        height: dp(40)
                        on_release: root.filter_projects("recent")

                        MDButtonText:
                            text: "Recent"
                            theme_font_size: "Custom"
                            font_size: dp(12)

                    MDButton:
                        id: filter_synced_btn
                        style: "outlined"
                        size_hint_x: None
                        width: dp(100)
                        size_hint_y: None
                        height: dp(40)
                        on_release: root.filter_projects("synced")

                        MDButtonText:
                            text: "Synced"
                            theme_font_size: "Custom"
                            font_size: dp(12)

                    MDButton:
                        id: filter_pending_btn
                        style: "outlined"
                        size_hint_x: None
                        width: dp(100)
                        size_hint_y: None
                        height: dp(40)
                        on_release: root.filter_projects("pending")

                        MDButtonText:
                            text: "Pending"
                            theme_font_size: "Custom"
                            font_size: dp(12)

                    Widget:  # Spacer

                    # Sort and View Controls
                    MDIconButton:
                        icon: "sort"
                        size_hint: None, None
                        size: dp(40), dp(40)
                        theme_icon_color: "Primary"
                        pos_hint: {"center_y": 0.5}
                        on_release: root.show_sort_menu()

                    MDIconButton:
                        id: view_toggle_btn
                        icon: "view-grid"
                        size_hint: None, None
                        size: dp(40), dp(40)
                        theme_icon_color: "Primary"
                        pos_hint: {"center_y": 0.5}
                        on_release: root.toggle_view_mode()

            # Projects Grid Container with modern scrolling
            MDCard:
                orientation: "vertical"
                adaptive_height: True
                size_hint_y: None
                height: self.minimum_height
                padding: dp(16)
                elevation: 2
                radius: dp(16)
                md_bg_color: app.theme_cls.surfaceContainerColor

                MDScrollView:
                    size_hint: 1, 1
                    do_scroll_x: False
                    bar_width: dp(4)

                    MDGridLayout:
                        id: projects_grid
                        cols: 1  # Will be dynamically adjusted
                        spacing: dp(16)
                        adaptive_height: True
                        size_hint_y: None
                        height: self.minimum_height